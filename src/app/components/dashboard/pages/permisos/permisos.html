<div class="space-y-6">
  <div class="text-center space-y-2">
    <h2 class="text-xl font-bold">Gesti√≥n de Permisos</h2>
    <p class="text-sm text-textc-mute max-w-2xl mx-auto">
      Este m√≥dulo controla qu√© formularios puede ver cada rol. 
      Si asignas un formulario a un rol, ese rol tendr√° acceso completo (crear, leer, actualizar, eliminar) a ese formulario.
      <br><strong>Ejemplo:</strong> Si asignas "Ventas" al rol "Vendedor", entonces los usuarios con rol "Vendedor" podr√°n ver y usar el formulario de Ventas.
    </p>
  </div>

  <!-- Alertas -->
  <div *ngIf="okMsg"
       class="mx-auto w-full max-w-4xl rounded-xl border border-green-500/40 bg-green-500/10 px-4 py-3 text-green-300 text-center">
    {{ okMsg }}
  </div>
  <div *ngIf="errorMsg"
       class="mx-auto w-full max-w-4xl rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-red-300 text-center whitespace-pre-line">
    {{ errorMsg }}
  </div>
  <div *ngIf="errorMsgInline"
       class="mx-auto w-full max-w-4xl rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-red-300 text-center">
    {{ errorMsgInline }}
  </div>

  <!-- Card: Asignaci√≥n de permisos -->
  <section class="mx-auto w-full max-w-4xl rounded-2xl bg-surface-800 border border-white/5 p-6 sm:p-7">
    <h3 class="text-lg font-semibold text-brand-500 mb-4">Asignaci√≥n de permisos</h3>
    <p class="text-sm text-textc-mute mb-4">
      Selecciona un rol y marca los formularios que deseas asignar. <strong>Importante:</strong> Los formularios padre (üìÅ) no se pueden asignar directamente, solo sus hijos (üìÑ). 
      Si asignas un formulario hijo, el padre se asignar√° autom√°ticamente. Al asignar un permiso, el rol tendr√° acceso completo (crear, leer, actualizar, eliminar) al formulario.
      <br><strong>Ejemplo:</strong> Seleccionas "Vendedor" y marcas "Permisos" (hijo de "Seguridad") ‚Üí se asignan ambos: "Permisos" y su padre "Seguridad" autom√°ticamente.
    </p>

    <div class="space-y-4">
      <!-- Selecci√≥n de rol -->
      <div>
        <label class="block text-sm mb-1">Rol <span class="text-brand-500">*</span></label>
        <select [value]="form.value.id_rol || ''"
                (change)="form.patchValue({ id_rol: $any($event.target).value })"
                class="w-full rounded-xl bg-surface-900 border border-white/10 px-4 py-3 outline-none focus:border-brand-500">
          <option value="">Seleccionar rol‚Ä¶</option>
          <option *ngFor="let r of roles" [value]="r.id_rol">
            {{ r.nombre_rol }}
          </option>
        </select>
      </div>

      <!-- Lista de formularios con checkboxes agrupados -->
      <div *ngIf="form.value.id_rol && !loadingFormularios && formularios.length > 0" 
           class="max-h-96 overflow-y-auto border border-white/10 rounded-xl p-4 space-y-4">
        
        <!-- Formularios padre con sus hijos -->
        <div *ngFor="let padre of formulariosAgrupados.padres" class="space-y-2">
          <div class="flex items-center gap-3 py-2 border-b border-white/5">
            <input type="checkbox"
                   [checked]="false"
                   [disabled]="true"
                   class="w-4 h-4 rounded border-white/20 bg-surface-900 text-brand-500 opacity-50 cursor-not-allowed">
            <label class="flex-1">
              <span class="font-semibold text-blue-400">üìÅ {{ padre.titulo_formulario }} (Padre)</span>
              <span *ngIf="form.value.id_rol && tienePermiso(toNumber(form.value.id_rol), padre.id_formulario)"
                    class="text-xs text-green-400 ml-2">‚úì Ya asignado</span>
            </label>
          </div>
          
          <!-- Hijos del padre -->
          <div *ngIf="padre.hijos.length > 0" class="ml-6 space-y-1">
            <div *ngFor="let hijo of padre.hijos" class="flex items-center gap-3 py-1">
              <input type="checkbox"
                     [checked]="estaSeleccionadoBulk(hijo.id_formulario)"
                     (change)="toggleFormularioBulk(hijo.id_formulario)"
                     [disabled]="form.value.id_rol && tienePermiso(toNumber(form.value.id_rol), hijo.id_formulario)"
                     class="w-4 h-4 rounded border-white/20 bg-surface-900 text-brand-500 focus:ring-brand-500 cursor-pointer">
              <label class="flex-1 cursor-pointer">
                <span class="font-medium">{{ hijo.titulo_formulario }}</span>
                <span class="text-xs text-purple-400 ml-2">üìÑ (Hijo)</span>
                <span *ngIf="form.value.id_rol && tienePermiso(toNumber(form.value.id_rol), hijo.id_formulario)"
                      class="text-xs text-green-400 ml-2">‚úì Ya asignado</span>
              </label>
            </div>
          </div>
          <div *ngIf="padre.hijos.length === 0" class="ml-6 text-xs text-yellow-400">
            ‚ö†Ô∏è Este padre no tiene hijos asignables
          </div>
        </div>

        <!-- Formularios independientes (sin padre) -->
        <div *ngIf="formulariosAgrupados.independientes.length > 0" class="space-y-2 pt-2 border-t border-white/10">
          <div *ngFor="let f of formulariosAgrupados.independientes" class="flex items-center gap-3 py-1">
            <input type="checkbox"
                   [checked]="estaSeleccionadoBulk(f.id_formulario)"
                   (change)="toggleFormularioBulk(f.id_formulario)"
                   [disabled]="form.value.id_rol && tienePermiso(toNumber(form.value.id_rol), f.id_formulario)"
                   class="w-4 h-4 rounded border-white/20 bg-surface-900 text-brand-500 focus:ring-brand-500 cursor-pointer">
            <label class="flex-1 cursor-pointer">
              <span class="font-medium">{{ f.titulo_formulario }}</span>
              <span *ngIf="form.value.id_rol && tienePermiso(toNumber(form.value.id_rol), f.id_formulario)"
                    class="text-xs text-green-400 ml-2">‚úì Ya asignado</span>
            </label>
          </div>
        </div>
      </div>

      <div *ngIf="loadingFormularios" class="text-center text-textc-mute py-4">
        ‚è≥ Cargando formularios...
      </div>


      <div *ngIf="form.value.id_rol && !loadingFormularios && formularios.length === 0" 
           class="text-center text-yellow-400 py-4 border border-yellow-500/20 rounded-xl bg-yellow-500/10">
        ‚ö†Ô∏è No hay formularios disponibles en la base de datos.
      </div>

      <!-- Bot√≥n -->
      <button type="button"
              [disabled]="saving || !form.value.id_rol || formulariosSeleccionados.size === 0"
              (click)="submitBulk()"
              class="w-full rounded-xl border-2 border-dashed border-brand-500/70 text-brand-500
                     font-semibold py-3 hover:bg-brand-500 hover:text-black transition
                     focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500
                     disabled:opacity-50 disabled:cursor-not-allowed">
        {{ saving ? 'Guardando‚Ä¶' : `Asignar ${formulariosSeleccionados.size} formulario(s)` }}
      </button>
    </div>
  </section>

  <!-- Card: Listado de permisos asignados -->
  <section class="mx-auto w-full max-w-5xl">
    <div class="rounded-2xl bg-surface-800 border border-white/5 overflow-hidden">
      <div class="px-6 py-4 border-b border-white/5 font-semibold flex justify-between items-center">
        <span>Permisos asignados</span>
        <button type="button"
                (click)="loadPermisosAsignados()"
                class="text-sm text-brand-500 hover:text-brand-400">
          üîÑ Actualizar
        </button>
      </div>

      <!-- Cargando -->
      <div *ngIf="loadingList" class="px-6 py-10 text-center text-textc-mute">
        Cargando...
      </div>

      <!-- Vac√≠o -->
      <div *ngIf="!loadingList && permisosAsignados.length === 0" class="px-6 py-10 text-center text-textc-mute">
        No hay permisos asignados.
      </div>

      <!-- Tabla -->
      <div *ngIf="!loadingList && permisosAsignados.length > 0" class="overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead class="bg-surface-900/60">
            <tr class="border-b border-white/5">
              <th class="px-6 py-3">Rol</th>
              <th class="px-6 py-3">Formulario</th>
              <th class="px-6 py-3">Tipo</th>
              <th class="px-6 py-3">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let pm of permisosAsignados" class="border-b border-white/5">
              <td class="px-6 py-3">
                <div class="font-semibold">{{ getNombreRol(pm.id_rol) }}</div>
                <div class="text-xs text-textc-mute">ID: {{ pm.id_rol }}</div>
              </td>
              <td class="px-6 py-3">
                <div>{{ pm.titulo_formulario }}</div>
                <div class="text-xs text-textc-mute">ID: {{ pm.id_formulario }}</div>
              </td>
              <td class="px-6 py-3">
                <span *ngIf="pm.is_padre" class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-blue-500/20 text-blue-400">
                  Padre
                </span>
                <span *ngIf="!pm.is_padre && pm.padre_id" class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-purple-500/20 text-purple-400">
                  Hijo
                </span>
                <span *ngIf="!pm.is_padre && !pm.padre_id" class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-gray-500/20 text-gray-400">
                  Independiente
                </span>
              </td>
              <td class="px-6 py-3">
                <button type="button"
                        (click)="confirmarEliminar(pm.id_rol, pm.id_formulario)"
                        class="text-red-400 hover:text-red-300 text-sm">
                  Eliminar
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Modal de confirmaci√≥n -->
  <div *ngIf="confirmOpen" class="fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60"></div>

    <div class="relative z-[61] w-full max-w-md rounded-2xl bg-surface-800 border border-white/10 p-6 shadow-xl">
      <h3 class="text-lg font-semibold mb-2">Confirmar eliminaci√≥n</h3>
      <p class="text-sm text-textc-mute mb-4">
        ¬øEst√°s seguro de eliminar este permiso?
        <span *ngIf="pendingDelete" class="block mt-2">
          <strong>Rol:</strong> {{ getNombreRol(pendingDelete.idRol) }}<br>
          <strong>Formulario:</strong> {{ getNombreFormulario(pendingDelete.idFormulario) }}
        </span>
        <span class="block mt-2 text-yellow-400 text-xs">
          ‚ö†Ô∏è Si el formulario es padre, tambi√©n se eliminar√°n todos sus hijos.
        </span>
      </p>

      <div class="mt-6 flex gap-3 justify-end">
        <button type="button" class="rounded-xl border border-white/10 px-4 py-2 hover:bg-white/5"
                (click)="closeConfirm()">
          Cancelar
        </button>
        <button type="button"
                class="rounded-xl bg-red-500/90 text-black font-semibold px-4 py-2 hover:bg-red-400"
                (click)="doEliminarConfirmado()">
          Eliminar
        </button>
      </div>
    </div>
  </div>
</div>
