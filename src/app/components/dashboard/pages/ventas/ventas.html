<div class="space-y-6">
    <h2 class="text-center text-xl font-bold">
        Registrar Venta
    </h2>

    <!-- Mensajes -->
    <div *ngIf="okMsg"
        class="mx-auto w-full max-w-4xl rounded-xl border border-green-500/40 bg-green-500/10 px-4 py-3 text-green-300 text-center">
        {{ okMsg }}
    </div>
    <div *ngIf="errorMsg"
        class="mx-auto w-full max-w-4xl rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-red-300 text-center">
        {{ errorMsg }}
    </div>

    <!-- Violaciones -->
    <div *ngIf="violations.length > 0"
        class="mx-auto w-full max-w-4xl rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-red-300">
        <div class="font-semibold mb-2">{{ violTitle || 'Productos en conflicto:' }}</div>
        <ul class="list-disc ml-6 space-y-1">
            <li *ngFor="let v of violations">
                <span class="text-white">{{ v.nombre || ('#' + v.producto_id) }}</span>
                <span class="opacity-80">
                    <ng-container *ngIf="v.type === 'NOT_ENOUGH'">
                        (Actual {{ v.actual }}, solicitado {{ v.solicitado }}, faltan {{ v.faltan }})
                    </ng-container>
                    <ng-container *ngIf="v.min != null && v.type !== 'NOT_ENOUGH'">
                        (Stock m√≠nimo {{ v.min }}, actual {{ v.actual }}, solicitado {{ v.solicitado }}, quedar√≠a {{
                        v.resultante }})
                    </ng-container>
                    <ng-container *ngIf="v.max != null">
                        (Stock m√°ximo {{ v.max }}, actual {{ v.actual }}, devolver {{ v.devolver }}, quedar√≠a {{
                        v.resultante }})
                    </ng-container>
                </span>
            </li>
        </ul>
    </div>

    <!-- Card: Formulario -->
    <section class="mx-auto w-full max-w-4xl rounded-2xl bg-surface-800 border border-white/5 p-6 sm:p-7">
        <h3 class="text-lg font-semibold text-brand-500 mb-4">
            Registrar venta
        </h3>

        <form [formGroup]="form" (ngSubmit)="submit()" class="space-y-4" novalidate>
            <div formArrayName="lineas" class="space-y-3">
                <div *ngFor="let l of lineas.controls; let i = index" class="grid gap-3 md:grid-cols-12 items-center"
                    [formGroupName]="i">
                    <!-- Producto -->
                    <div class="md:col-span-4">
                        <select
                            class="w-full rounded-xl bg-surface-900 border border-white/10 px-4 py-3 outline-none focus:border-brand-500"
                            formControlName="producto" (change)="onProductoChange(i)">
                            <option value="">Seleccionar producto</option>
                            <option *ngFor="let p of productos" [value]="p.id_producto"
                                [disabled]="isProductoOcupado(p.id_producto, i)">
                                {{ p.nombre_producto }}
                            </option>
                        </select>
                    </div>

                    <!-- Cantidad -->
                    <div class="md:col-span-3">
                        <input type="text" inputmode="numeric" autocomplete="off" placeholder="Cantidad (m√°x. 999.999)"
                            class="w-full rounded-xl bg-surface-900 border border-white/10 px-4 py-3 outline-none focus:border-brand-500 placeholder:text-[14px]"
                            [value]="getCantidadMasked(i)"
                            (beforeinput)="onBeforeInputDigits($event, i, 6)"
                            (input)="onInputMasked(i, 'cantidad', 6, $event)" />
                    </div>

                    <!-- Precio unitario -->
                    <div class="md:col-span-2 text-sm">
                        <div class="text-textc-mute">Precio unit:</div>
                        <div class="font-semibold">
                            {{ (lineas.at(i).get('precioUnit')?.value || 0) | currency:'COP':'symbol-narrow':'1.0-0' }}
                        </div>
                    </div>

                    <!-- Subtotal -->
                    <div class="md:col-span-2 text-sm">
                        <div class="text-textc-mute">Subtotal:</div>
                        <div class="font-semibold text-brand-500">
                            {{ subtotal(i) | currency:'COP':'symbol-narrow':'1.0-0' }}
                        </div>
                    </div>

                    <div class="md:col-span-1 flex justify-end">
                        <button type="button" class="px-2 py-2 rounded-lg text-pink-400 hover:text-pink-300"
                            (click)="eliminarLinea(i)" aria-label="Quitar producto" title="Quitar producto">
                            ‚úï
                        </button>
                    </div>
                </div>
            </div>

            <button type="button"
                class="w-full rounded-xl border-2 border-dashed border-brand-500/70 text-brand-500 font-semibold py-3 px-5 hover:bg-brand-500 hover:text-black transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500"
                (click)="agregarLinea()">
                + Agregar producto
            </button>

            <!-- Resumen de productos -->
            <div class="mt-4 pt-4 border-t border-white/10">
                <div class="text-center font-semibold whitespace-nowrap">
                    Total productos:
                    <span class="text-brand-500">{{ total | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
                </div>
            </div>

            <!-- Pagos -->
            <div class="mt-6 pt-6 border-t border-white/10">
                <h4 class="text-md font-semibold mb-3">M√©todos de pago</h4>
                <div formArrayName="pagos" class="space-y-3">
                    <div *ngFor="let p of pagos.controls; let i = index" class="grid gap-3 md:grid-cols-12 items-center"
                        [formGroupName]="i">
                        <!-- M√©todo de pago -->
                        <div class="md:col-span-4">
                            <select
                                class="w-full rounded-xl bg-surface-900 border border-white/10 px-4 py-3 outline-none focus:border-brand-500"
                                formControlName="id_metodo_pago">
                                <option value="">Seleccionar m√©todo</option>
                                <option *ngFor="let mp of metodosPago" [value]="mp.id_metodo_pago">
                                    {{ mp.nombre_metodo_pago }}
                                </option>
                            </select>
                        </div>

                        <!-- Monto -->
                        <div class="md:col-span-3">
                            <input type="text" inputmode="numeric" autocomplete="off" placeholder="Monto (m√°x. 99.999.999)"
                                class="w-full rounded-xl bg-surface-900 border border-white/10 px-4 py-3 outline-none focus:border-brand-500 placeholder:text-[14px]"
                                [value]="getMontoMasked(i)"
                                (beforeinput)="onBeforeInputDigits($event, i, 8)"
                                (input)="onInputMontoMasked(i, 8, $event)" />
                        </div>

                        <!-- Observaciones del pago -->
                        <div class="md:col-span-4">
                            <input type="text" placeholder="Observaciones (opcional)"
                                class="w-full rounded-xl bg-surface-900 border border-white/10 px-4 py-3 outline-none focus:border-brand-500 placeholder:text-[14px]"
                                formControlName="observaciones" />
                        </div>

                        <div class="md:col-span-1 flex justify-end">
                            <button type="button" class="px-2 py-2 rounded-lg text-pink-400 hover:text-pink-300"
                                (click)="eliminarPago(i)" aria-label="Quitar pago" title="Quitar pago">
                                ‚úï
                            </button>
                        </div>
                    </div>
                </div>

                <button type="button"
                    class="w-full mt-3 rounded-xl border-2 border-dashed border-brand-500/70 text-brand-500 font-semibold py-3 px-5 hover:bg-brand-500 hover:text-black transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500"
                    (click)="agregarPago()">
                    + Agregar m√©todo de pago
                </button>

                <!-- Resumen de pagos -->
                <div class="mt-4 pt-4 border-t border-white/10 space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-textc-mute">Total pagado:</span>
                        <span class="font-semibold">{{ totalPagos | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
                    </div>
                    <div *ngIf="esVentaFiada" class="flex justify-between text-sm">
                        <span class="text-textc-mute">Saldo pendiente:</span>
                        <span class="font-semibold text-yellow-400">{{ saldoPendiente | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
                    </div>
                    <div *ngIf="esVentaFiada" class="text-xs text-yellow-400 mt-2">
                        ‚ö†Ô∏è Esta ser√° una venta fiada
                    </div>
                </div>
            </div>

            <!-- Cliente (solo para ventas fiadas) -->
            <div *ngIf="requiereCliente" class="mt-6 pt-6 border-t border-white/10">
                <label class="block text-sm font-semibold mb-2">
                    Cliente <span class="text-red-400">*</span>
                </label>
                <input type="text" placeholder="Nombre del cliente (obligatorio para ventas fiadas)"
                    class="w-full rounded-xl bg-surface-900 border border-white/10 px-4 py-3 outline-none focus:border-brand-500 placeholder:text-[14px]"
                    formControlName="cliente_desc" maxlength="200" />
            </div>

            <!-- Fecha y observaciones -->
            <div class="mt-6 pt-6 border-t border-white/10 grid gap-4 md:grid-cols-2">
                <div>
                    <label class="block text-sm font-semibold mb-2">Fecha y hora de venta</label>
                    <input type="datetime-local"
                        class="input-datetime w-full rounded-xl bg-surface-900 border border-brand-500/50 px-4 py-3 outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 text-white font-semibold"
                        formControlName="fecha_venta" />
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Observaciones</label>
                    <input type="text" placeholder="Observaciones generales (opcional)"
                        class="w-full rounded-xl bg-surface-900 border border-white/10 px-4 py-3 outline-none focus:border-brand-500 placeholder:text-[14px]"
                        formControlName="observaciones" />
                </div>
            </div>

            <div class="mt-6 flex items-center gap-3">
                <button type="submit" [disabled]="saving" class="rounded-xl border-2 border-dashed border-brand-500/70 text-brand-500 font-semibold px-5 py-3
                       hover:bg-brand-500 hover:text-black transition focus-visible:outline-none focus-visible:ring-2
                       focus-visible:ring-brand-500 basis-[100%] lg:basis-[100%]">
                    {{ saving ? 'Guardando...' : 'Registrar venta' }}
                </button>
            </div>
        </form>
    </section>

    <!-- Card: Listado -->
    <section class="mx-auto w-full max-w-5xl mt-8">
        <div class="rounded-2xl bg-surface-800 border border-white/5 overflow-hidden">
            <div class="px-6 py-4 border-b border-white/5 font-semibold flex items-center justify-between">
                <span>Ventas registradas</span>
                <label class="flex items-center gap-2 cursor-pointer font-normal text-sm">
                    <input type="checkbox"
                           [checked]="mostrarEliminadas"
                           (change)="toggleMostrarEliminadas()"
                           class="w-4 h-4 rounded">
                    <span [class.text-red-400]="mostrarEliminadas">
                        {{ mostrarEliminadas ? 'üóëÔ∏è Mostrando eliminadas' : 'üìã Mostrar eliminadas' }}
                    </span>
                </label>
            </div>

            <div *ngIf="rows.length === 0" class="px-6 py-10 text-center text-textc-mute">
                No hay registros
            </div>

            <div *ngIf="rows.length > 0" class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-surface-900/60 sticky top-0">
                        <tr class="border-b border-white/5">
                            <th class="px-6 py-3">Folio</th>
                            <th class="px-6 py-3">Productos</th>
                            <th class="px-6 py-3">Fecha</th>
                            <th class="px-6 py-3 text-right">Total</th>
                            <th class="px-6 py-3">Estado</th>
                            <!-- Columna Motivo - Solo si mostrando eliminadas -->
                            <th *ngIf="mostrarEliminadas" class="px-6 py-3">Motivo</th>
                            <th class="px-6 py-3">Cliente</th>
                            <th class="px-6 py-3">Usuario</th>
                            <!-- Columna Acciones - Solo si mostrando activas -->
                            <th *ngIf="!mostrarEliminadas" class="px-6 py-3 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let r of rows" class="border-b border-white/5 transition-colors"
                            [class.bg-yellow-500/5]="r.es_fiado && r.estado === 'PENDIENTE'"
                            [class.bg-red-500/5]="estaEliminada(r)"
                            [class.hover:bg-yellow-500/10]="r.es_fiado && r.estado === 'PENDIENTE' && estaActiva(r)"
                            [class.hover:bg-surface-900/30]="!r.es_fiado && estaActiva(r)"
                            [class.hover:bg-red-500/10]="estaEliminada(r)"
                            [class.opacity-70]="estaEliminada(r)">
                            <td class="px-6 py-3">
                                <span class="font-mono text-xs text-brand-400">{{ r.folio }}</span>
                            </td>
                            <td class="px-6 py-3 text-sm">
                                <div class="relative group inline-block">
                                    <span class="text-gray-300">{{ getPrimerosProductos(r) }}</span>
                                    <span *ngIf="getProductosAdicionales(r) > 0"
                                          class="ml-1 px-2 py-0.5 bg-brand-500/20 text-brand-400 rounded text-xs cursor-help">
                                        +{{ getProductosAdicionales(r) }} m√°s
                                    </span>
                                    <!-- Tooltip elegante -->
                                    <div *ngIf="getProductosAdicionales(r) > 0"
                                         class="absolute left-0 top-full mt-2 w-64 p-3 rounded-lg bg-surface-900
                                                border border-brand-500/30 shadow-2xl opacity-0 invisible
                                                group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50
                                                pointer-events-none">
                                        <div class="text-xs font-semibold text-brand-400 mb-2">
                                            Todos los productos ({{ r.total_productos }})
                                        </div>
                                        <div class="text-xs text-gray-300 whitespace-pre-line leading-relaxed">
                                            {{ getProductosCompletos(r) }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-3 text-sm text-gray-400">{{ r.fecha | date:'dd/MM/yy HH:mm' }}</td>
                            <td class="px-6 py-3 text-right font-semibold">{{ r.total | currency:'COP':'symbol-narrow':'1.0-0' }}</td>
                            <td class="px-6 py-3">
                                <span *ngIf="estaEliminada(r)" class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-red-500/20 text-red-400">
                                    üóëÔ∏è ELIMINADA
                                </span>
                                <span *ngIf="estaActiva(r) && !r.es_fiado" class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-green-500/20 text-green-400">
                                    PAGADA
                                </span>
                                <span *ngIf="estaActiva(r) && r.es_fiado && r.estado === 'PENDIENTE'"
                                      class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-yellow-500/20 text-yellow-400">
                                    FIADA ({{ r.saldo_pendiente | currency:'COP':'symbol-narrow':'1.0-0' }})
                                </span>
                                <span *ngIf="estaActiva(r) && r.es_fiado && r.estado === 'PAGADA'"
                                      class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-green-500/20 text-green-400">
                                    PAGADA ‚úì
                                </span>
                            </td>
                            <!-- Columna Motivo - Solo si mostrando eliminadas -->
                            <td *ngIf="mostrarEliminadas" class="px-6 py-3 text-sm">
                                <div class="relative group inline-block w-full">
                                    <!-- Motivo -->
                                    <span *ngIf="r.motivo_eliminacion"
                                          class="text-red-300 truncate max-w-xs inline-block cursor-help">
                                        {{ r.motivo_eliminacion.length > 40 ? (r.motivo_eliminacion | slice:0:40) + '...' : r.motivo_eliminacion }}
                                    </span>
                                    <span *ngIf="!r.motivo_eliminacion"
                                          class="text-gray-500 italic">
                                        Sin especificar
                                    </span>

                                    <!-- Tooltip con motivo completo -->
                                    <div *ngIf="r.motivo_eliminacion && r.motivo_eliminacion.length > 40"
                                         class="absolute left-0 top-full mt-1 w-64 p-3 rounded-lg bg-red-900/80 border border-red-500/50
                                                opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50
                                                pointer-events-none text-xs text-red-100">
                                        {{ r.motivo_eliminacion }}
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-3 text-sm">
                                <span *ngIf="r.cliente_desc">{{ r.cliente_desc }}</span>
                                <span *ngIf="!r.cliente_desc" class="text-gray-500">-</span>
                            </td>
                            <td class="px-6 py-3 text-sm text-gray-400">{{ r.usuario }}</td>
                            <!-- Columna Acciones - Solo si mostrando activas -->
                            <td *ngIf="!mostrarEliminadas" class="px-6 py-3 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <!-- Bot√≥n Abonar (solo para ventas fiadas pendientes y activas) -->
                                    <button *ngIf="r.es_fiado && r.estado === 'PENDIENTE'"
                                            class="px-3 py-1.5 text-xs font-semibold bg-brand-500/20 text-brand-400 rounded-lg hover:bg-brand-500/30 transition"
                                            type="button"
                                            (click)="abrirModalAbonos(r)">
                                        üí∞ Abonar
                                    </button>
                                    <!-- Bot√≥n Eliminar -->
                                    <button class="text-red-400 hover:text-red-300 font-semibold text-xs transition"
                                            type="button"
                                            title="Eliminar venta"
                                            (click)="confirmarEliminar(r.id_venta)">
                                        Eliminar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </section>

    <!-- Modal de confirmaci√≥n -->
    <div *ngIf="confirmOpen" class="fixed inset-0 z-[60] flex items-center justify-center">
        <div class="absolute inset-0 bg-black/60"></div>

        <div class="relative z-[61] w-full max-w-md rounded-2xl bg-surface-800 border border-white/10 p-6 shadow-xl">
            <h3 class="text-lg font-semibold mb-2">‚ö†Ô∏è Confirmar eliminaci√≥n</h3>
            <p class="text-sm text-textc-mute">¬øSeguro que deseas eliminar esta venta?</p>

            <div class="mt-4">
                <label class="block text-sm font-semibold mb-2">
                    Motivo <span class="text-red-400">*</span> (obligatorio, m√≠nimo 5 caracteres)
                </label>
                <textarea
                    [(ngModel)]="motivoEliminacion"
                    placeholder="Ej: Error de registro, venta duplicada, cliente rechaz√≥..."
                    class="w-full rounded-lg bg-surface-900 border border-white/10 px-4 py-3 outline-none focus:border-red-500 text-sm resize-none"
                    [class.border-red-500]="motivoEliminacion.trim().length < 5 && motivoEliminacion.length > 0"
                    rows="3"
                    maxlength="500"></textarea>
                <div class="flex justify-between text-xs mt-1">
                    <span [class.text-red-400]="motivoEliminacion.trim().length < 5">
                        {{ motivoEliminacion.length }}/500 caracteres
                    </span>
                    <span *ngIf="motivoEliminacion.trim().length < 5 && motivoEliminacion.length > 0" class="text-red-400">
                        ‚ö†Ô∏è M√≠nimo 5 caracteres
                    </span>
                </div>
            </div>

            <div class="mt-6 flex gap-3 justify-end">
                <button type="button" class="rounded-xl border border-white/10 px-4 py-2 hover:bg-white/5"
                    (click)="closeConfirm()">
                    Cancelar
                </button>
                <button type="button"
                    class="rounded-xl bg-red-500/90 text-black font-semibold px-4 py-2 hover:bg-red-400 transition"
                    (click)="doEliminarConfirmado()">
                    üóëÔ∏è Eliminar venta
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de abonos -->
    <app-abonos-modal
        *ngIf="mostrarModalAbonos && ventaSeleccionada"
        [venta]="ventaSeleccionada"
        (cerrar)="cerrarModalAbonos($event)">
    </app-abonos-modal>
</div>
