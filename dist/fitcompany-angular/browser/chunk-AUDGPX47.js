import{a as J}from"./chunk-3CZEIJU6.js";import{a as Y}from"./chunk-ODDEEUQE.js";import{a as xe}from"./chunk-QEMDHJXP.js";import{b as L,c as S,d as j,e as H,f as me,g as q,h as z,i as pe,j as ce,k as U,l as R,m as W,n as X,o as ue,p as K,q as ge,r as Q}from"./chunk-R2MBKBQG.js";import"./chunk-Y5NMKK7J.js";import{B as P,Ca as k,Ga as g,Ia as ne,Mb as O,Nb as F,Ob as $,Qb as B,R as I,Rb as de,Sa as d,Sb as G,Ta as o,Ua as i,Va as M,Wa as D,X as y,Xa as N,Y as E,Ya as A,Za as f,_a as p,cb as ie,db as T,eb as a,fb as _,gb as u,ib as oe,jb as te,kb as re,lb as ae,mb as le,sb as v,ta as l,tb as V,ub as se,vb as h}from"./chunk-4VXNIXON.js";function ye(r,t){if(r&1&&(o(0,"div",45),a(1),i()),r&2){let e=p();l(),u(" ",e.okMsg," ")}}function Ee(r,t){if(r&1&&(o(0,"div",46),a(1),i()),r&2){let e=p();l(),u(" ",e.errorMsg," ")}}function we(r,t){r&1&&(o(0,"div",47),a(1,"Cargando..."),i())}function Se(r,t){r&1&&(o(0,"div",47),a(1," No hay abonos registrados a\xFAn "),i())}function Ce(r,t){if(r&1&&(o(0,"tr",55)(1,"td",56),a(2),v(3,"date"),i(),o(4,"td",56),a(5),i(),o(6,"td",57),a(7),v(8,"currency"),i(),o(9,"td",58),a(10),i()()),r&2){let e=t.$implicit;l(2),u(" ",V(3,4,e.fecha_pago,"dd/MM/yy HH:mm")," "),l(3),u(" ",e.metodo_pago," "),l(2),u(" ",h(8,7,e.monto,"COP","symbol-narrow","1.0-0")," "),l(3),u(" ",e.observaciones||"-"," ")}}function Ie(r,t){if(r&1&&(o(0,"div",48)(1,"table",49)(2,"thead",50)(3,"tr",51)(4,"th",52),a(5,"Fecha"),i(),o(6,"th",52),a(7,"M\xE9todo"),i(),o(8,"th",53),a(9,"Monto"),i(),o(10,"th",52),a(11,"Observaciones"),i()()(),o(12,"tbody"),g(13,Ce,11,12,"tr",54),i()()()),r&2){let e=p();l(13),d("ngForOf",e.abonos)}}function Me(r,t){if(r&1&&(o(0,"option",59),a(1),i()),r&2){let e=t.$implicit;d("value",e.id_metodo_pago),l(),u(" ",e.nombre_metodo_pago," ")}}function Ae(r,t){r&1&&(o(0,"p",60),a(1," El m\xE9todo de pago es requerido "),i())}function Te(r,t){r&1&&(o(0,"p",60),a(1," El monto es requerido "),i())}function Ve(r,t){r&1&&(o(0,"p",60),a(1," El monto debe ser mayor a $0 "),i())}function Pe(r,t){if(r&1&&(o(0,"p",60),a(1),i()),r&2){let e,n=p();l(),u(" El monto ($",n.getMasked((e=n.form.get("monto"))==null?null:e.value),") no puede exceder el saldo pendiente ")}}function ke(r,t){r&1&&(o(0,"span"),a(1,"Registrar Abono"),i())}function De(r,t){r&1&&(o(0,"span"),a(1,"Guardando..."),i())}var Z=class r{venta;cerrar=new ne;fb=I(K);ventasSrv=I(Y);metodosPagoSrv=I(J);abonos=[];metodosPago=[];form;loading=!1;saving=!1;errorMsg="";okMsg="";ngOnInit(){this.form=this.fb.group({id_metodo_pago:["",S.required],monto:["",[S.required,S.min(1)]],observaciones:[""]}),this.cargarDatos()}cargarDatos(){this.loading=!0,this.errorMsg="",Promise.all([this.ventasSrv.obtenerAbonos(this.venta.id_venta).toPromise(),this.metodosPagoSrv.listar().toPromise()]).then(([t,e])=>{if(this.abonos=t?.abonos||[],this.metodosPago=e||[],t?.venta){this.venta.saldo_pendiente=t.venta.saldo_pendiente;let n=t.venta.estado;(n==="PENDIENTE"||n==="PAGADA"||n==="CANCELADA")&&(this.venta.estado=n)}}).catch(t=>{console.error("Error al cargar datos:",t),this.errorMsg="Error al cargar el historial de abonos"}).finally(()=>{this.loading=!1})}get porcentajePagado(){if(!this.venta.total||this.venta.total===0)return 0;let t=this.venta.total-(this.venta.saldo_pendiente||0);return Math.round(t/this.venta.total*100)}get montoPagado(){return this.venta.total-(this.venta.saldo_pendiente||0)}getMasked(t){return!t&&t!==0?"":Number(String(t).replace(/\D/g,"")).toLocaleString("es-CO")}unmask(t){return t?Number(String(t).replace(/\D/g,"")):0}onInputMonto(t){let e=t.target,n=e.value.replace(/\D/g,""),s=Number(n);e.value=this.getMasked(s),this.form.patchValue({monto:n})}pagarTotal(){let t=Math.floor(this.venta.saldo_pendiente||0);this.form.patchValue({monto:t.toString()})}registrarAbono(){if(this.form.invalid){this.form.markAllAsTouched();return}let t=this.unmask(this.form.value.monto);if(t<=0){this.errorMsg="El monto debe ser mayor a $0";return}if(t>(this.venta.saldo_pendiente||0)){this.errorMsg="El monto no puede exceder el saldo pendiente";return}let e={id_metodo_pago:Number(this.form.value.id_metodo_pago),monto:t,observaciones:this.form.value.observaciones?.trim()||null};this.saving=!0,this.errorMsg="",this.okMsg="",this.ventasSrv.registrarAbono(this.venta.id_venta,e).pipe(P(()=>this.saving=!1)).subscribe({next:n=>{let s=n.venta?.saldo_nuevo||0;this.okMsg=n.message||`Abono registrado. Saldo restante: $${s.toLocaleString("es-CO")}`,setTimeout(()=>{this.cerrar.emit(!0)},1500)},error:n=>{this.errorMsg=n?.error?.message||"Error al registrar el abono"}})}cerrarModal(){this.cerrar.emit(!1)}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=k({type:r,selectors:[["app-abonos-modal"]],inputs:{venta:"venta"},outputs:{cerrar:"cerrar"},decls:94,vars:45,consts:[[1,"fixed","inset-0","bg-black/70","backdrop-blur-sm","z-50","flex","items-center","justify-center","p-4",3,"click"],[1,"bg-surface-800","rounded-2xl","border","border-white/10","shadow-2xl","w-full","max-w-2xl","max-h-[90vh]","overflow-y-auto",3,"click"],[1,"sticky","top-0","bg-surface-800","border-b","border-white/10","px-6","py-4","flex","items-center","justify-between","z-10"],[1,"text-xl","font-bold","text-brand-400"],[1,"text-sm","text-gray-400","mt-1"],["type","button",1,"text-gray-400","hover:text-white","text-2xl","leading-none",3,"click"],[1,"p-6","space-y-6"],["class","rounded-xl border border-green-500/40 bg-green-500/10 px-4 py-3 text-green-300 text-sm",4,"ngIf"],["class","rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-red-300 text-sm",4,"ngIf"],[1,"bg-surface-900/60","rounded-xl","p-5","border","border-white/5"],[1,"grid","grid-cols-2","gap-4","mb-4"],[1,"text-xs","text-gray-500","uppercase","tracking-wide"],[1,"text-sm","font-semibold","text-white","mt-1"],[1,"mb-3"],[1,"flex","justify-between","text-xs","text-gray-400","mb-2"],[1,"h-3","bg-surface-950","rounded-full","overflow-hidden","border","border-white/5"],[1,"h-full","bg-gradient-to-r","from-brand-500","to-brand-400","transition-all","duration-300"],[1,"bg-surface-900/50","border-2","border-brand-500/60","rounded-lg","p-4","mt-4"],[1,"text-xs","text-gray-400","uppercase","tracking-wide","mb-1","font-semibold"],[1,"text-2xl","font-bold","text-white"],[1,"bg-surface-900/40","rounded-xl","p-5","border","border-white/5"],[1,"text-sm","font-semibold","text-gray-300","uppercase","tracking-wide","mb-3"],["class","text-center py-4 text-gray-500 text-sm",4,"ngIf"],["class","overflow-x-auto",4,"ngIf"],[1,"bg-surface-900/60","rounded-xl","p-5","border","border-brand-500/20"],[1,"text-sm","font-semibold","text-brand-400","uppercase","tracking-wide","mb-4"],[1,"space-y-4",3,"ngSubmit","formGroup"],[1,"block","text-sm","font-medium","text-gray-300","mb-2"],[1,"text-red-400"],["formControlName","id_metodo_pago",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","text-white","outline-none","focus:border-brand-500","transition"],["value",""],[3,"value",4,"ngFor","ngForOf"],["class","text-red-400 text-xs mt-1",4,"ngIf"],[1,"text-xs","text-gray-500","ml-2"],[1,"flex","gap-3"],[1,"flex-1","relative"],[1,"absolute","left-4","top-1/2","-translate-y-1/2","text-gray-400"],["type","text","inputmode","numeric","placeholder","0",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","pl-8","pr-4","py-3","text-white","outline-none","focus:border-brand-500","transition",3,"input","value"],["type","button",1,"flex-1","px-4","py-3","rounded-xl","bg-brand-500/10","border","border-brand-500/40","text-brand-400","hover:bg-brand-500/20","hover:border-brand-500/60","font-semibold","text-sm","transition","flex","items-center","justify-center","gap-2",3,"click"],[1,"text-gray-500","text-xs"],["formControlName","observaciones","rows","2","placeholder","Ej: Pago parcial, segunda cuota, etc.",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","text-white","outline-none","focus:border-brand-500","transition","resize-none"],[1,"flex","gap-3","pt-2"],["type","button",1,"flex-1","rounded-xl","border","border-white/20","text-gray-300","font-semibold","py-3","px-5","hover:bg-white/5","transition","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],["type","submit",1,"flex-1","rounded-xl","bg-brand-500","text-black","font-semibold","py-3","px-5","hover:bg-brand-400","transition","disabled:opacity-50","disabled:cursor-not-allowed",3,"disabled"],[4,"ngIf"],[1,"rounded-xl","border","border-green-500/40","bg-green-500/10","px-4","py-3","text-green-300","text-sm"],[1,"rounded-xl","border","border-red-500/40","bg-red-500/10","px-4","py-3","text-red-300","text-sm"],[1,"text-center","py-4","text-gray-500","text-sm"],[1,"overflow-x-auto"],[1,"w-full","text-xs"],[1,"border-b","border-white/10"],[1,"text-gray-400"],[1,"text-left","py-2","px-2"],[1,"text-right","py-2","px-2"],["class","border-b border-white/5 hover:bg-white/5",4,"ngFor","ngForOf"],[1,"border-b","border-white/5","hover:bg-white/5"],[1,"py-2","px-2","text-gray-300"],[1,"py-2","px-2","text-right","font-semibold","text-brand-400"],[1,"py-2","px-2","text-gray-400"],[3,"value"],[1,"text-red-400","text-xs","mt-1"]],template:function(e,n){if(e&1&&(o(0,"div",0),f("click",function(){return n.cerrarModal()}),o(1,"div",1),f("click",function(m){return m.stopPropagation()}),o(2,"div",2)(3,"div")(4,"h2",3),a(5,"\u{1F4B0} Abonar a Venta"),i(),o(6,"p",4),a(7),i()(),o(8,"button",5),f("click",function(){return n.cerrarModal()}),a(9," \u2715 "),i()(),o(10,"div",6),g(11,ye,2,1,"div",7)(12,Ee,2,1,"div",8),o(13,"div",9)(14,"div",10)(15,"div")(16,"p",11),a(17,"Cliente"),i(),o(18,"p",12),a(19),i()(),o(20,"div")(21,"p",11),a(22,"Total Venta"),i(),o(23,"p",12),a(24),v(25,"currency"),i()()(),o(26,"div",13)(27,"div",14)(28,"span"),a(29),v(30,"currency"),i(),o(31,"span"),a(32),i()(),o(33,"div",15),M(34,"div",16),i()(),o(35,"div",17)(36,"p",18),a(37," \u{1F4B0} Saldo Pendiente "),i(),o(38,"p",19),a(39),v(40,"currency"),i()()(),o(41,"div",20)(42,"h3",21),a(43," \u{1F4CB} Historial de Abonos "),i(),g(44,we,2,0,"div",22)(45,Se,2,0,"div",22)(46,Ie,14,1,"div",23),i(),o(47,"div",24)(48,"h3",25),a(49," \u2795 Registrar Nuevo Abono "),i(),o(50,"form",26),f("ngSubmit",function(){return n.registrarAbono()}),o(51,"div")(52,"label",27),a(53," M\xE9todo de pago "),o(54,"span",28),a(55,"*"),i()(),o(56,"select",29)(57,"option",30),a(58,"Seleccionar m\xE9todo"),i(),g(59,Me,2,2,"option",31),i(),g(60,Ae,2,0,"p",32),i(),o(61,"div")(62,"label",27),a(63," Monto "),o(64,"span",28),a(65,"*"),i(),o(66,"span",33),a(67),v(68,"currency"),i()(),o(69,"div",34)(70,"div",35)(71,"span",36),a(72,"$"),i(),o(73,"input",37),f("input",function(m){return n.onInputMonto(m)}),i()(),o(74,"button",38),f("click",function(){return n.pagarTotal()}),o(75,"span"),a(76,"\u{1F4B3}"),i(),o(77,"span"),a(78,"Pagar total"),i()()(),g(79,Te,2,0,"p",32)(80,Ve,2,0,"p",32)(81,Pe,2,1,"p",32),i(),o(82,"div")(83,"label",27),a(84," Observaciones "),o(85,"span",39),a(86,"(opcional)"),i()(),M(87,"textarea",40),i(),o(88,"div",41)(89,"button",42),f("click",function(){return n.cerrarModal()}),a(90," Cancelar "),i(),o(91,"button",43),g(92,ke,2,0,"span",44)(93,De,2,0,"span",44),i()()()()()()()),e&2){let s,m,c,x,b,w;l(7),_(n.venta.folio||"#"+n.venta.id_venta),l(4),d("ngIf",n.okMsg),l(),d("ngIf",n.errorMsg),l(7),u(" ",n.venta.cliente_desc||"Sin nombre"," "),l(5),u(" ",h(25,25,n.venta.total,"COP","symbol-narrow","1.0-0")," "),l(5),u("Pagado: ",h(30,30,n.montoPagado,"COP","symbol-narrow","1.0-0")),l(3),u("",n.porcentajePagado,"%"),l(2),ie("width",n.porcentajePagado,"%"),l(5),u(" ",h(40,35,n.venta.saldo_pendiente||0,"COP","symbol-narrow","1.0-0")," "),l(5),d("ngIf",n.loading),l(),d("ngIf",!n.loading&&n.abonos.length===0),l(),d("ngIf",!n.loading&&n.abonos.length>0),l(4),d("formGroup",n.form),l(9),d("ngForOf",n.metodosPago),l(),d("ngIf",((s=n.form.get("id_metodo_pago"))==null?null:s.touched)&&((s=n.form.get("id_metodo_pago"))==null?null:s.hasError("required"))),l(7),u(" (m\xE1x. ",h(68,40,n.venta.saldo_pendiente||0,"COP","symbol-narrow","1.0-0"),") "),l(6),d("value",n.getMasked((m=n.form.get("monto"))==null?null:m.value)),l(6),d("ngIf",((c=n.form.get("monto"))==null?null:c.touched)&&((c=n.form.get("monto"))==null?null:c.hasError("required"))),l(),d("ngIf",((x=n.form.get("monto"))==null?null:x.touched)&&((x=n.form.get("monto"))==null?null:x.hasError("min"))),l(),d("ngIf",n.unmask((b=n.form.get("monto"))==null?null:b.value)>(n.venta.saldo_pendiente||0)),l(8),d("disabled",n.saving),l(2),d("disabled",n.saving||n.form.invalid||n.unmask((w=n.form.get("monto"))==null?null:w.value)>(n.venta.saldo_pendiente||0)),l(),d("ngIf",!n.saving),l(),d("ngIf",n.saving)}},dependencies:[G,O,F,Q,q,W,X,L,R,j,H,z,U,B,$],encapsulation:2})};function Ne(r,t){if(r&1&&(o(0,"div",40),a(1),i()),r&2){let e=p();l(),u(" ",e.okMsg," ")}}function Oe(r,t){if(r&1&&(o(0,"div",41),a(1),i()),r&2){let e=p();l(),u(" ",e.errorMsg," ")}}function Fe(r,t){if(r&1&&(D(0),a(1),N()),r&2){let e=p().$implicit;l(),oe(" (Actual ",e.actual,", solicitado ",e.solicitado,", faltan ",e.faltan,") ")}}function $e(r,t){if(r&1&&(D(0),a(1),N()),r&2){let e=p().$implicit;l(),te(" (Stock m\xEDnimo ",e.min,", actual ",e.actual,", solicitado ",e.solicitado,", quedar\xEDa ",e.resultante,") ")}}function Be(r,t){if(r&1&&(D(0),a(1),N()),r&2){let e=p().$implicit;l(),te(" (Stock m\xE1ximo ",e.max,", actual ",e.actual,", devolver ",e.devolver,", quedar\xEDa ",e.resultante,") ")}}function Ge(r,t){if(r&1&&(o(0,"li")(1,"span",46),a(2),i(),o(3,"span",47),g(4,Fe,2,3,"ng-container",48)(5,$e,2,4,"ng-container",48)(6,Be,2,4,"ng-container",48),i()()),r&2){let e=t.$implicit;l(2),_(e.nombre||"#"+e.producto_id),l(2),d("ngIf",e.type==="NOT_ENOUGH"),l(),d("ngIf",e.min!=null&&e.type!=="NOT_ENOUGH"),l(),d("ngIf",e.max!=null)}}function Le(r,t){if(r&1&&(o(0,"div",42)(1,"div",43),a(2),i(),o(3,"ul",44),g(4,Ge,7,4,"li",45),i()()),r&2){let e=p();l(2),_(e.violTitle||"Productos en conflicto:"),l(2),d("ngForOf",e.violations)}}function je(r,t){if(r&1&&(o(0,"option",60),a(1),i()),r&2){let e=t.$implicit,n=p().index,s=p();d("value",e.id_producto)("disabled",s.isProductoOcupado(e.id_producto,n)),l(),u(" ",e.nombre_producto," ")}}function He(r,t){if(r&1){let e=A();o(0,"div",49)(1,"div",50)(2,"select",51),f("change",function(){let s=y(e).index,m=p();return E(m.onProductoChange(s))}),o(3,"option",52),a(4,"Seleccionar producto"),i(),g(5,je,2,3,"option",53),i()(),o(6,"div",54)(7,"input",55),f("beforeinput",function(s){let m=y(e).index,c=p();return E(c.onBeforeInputDigits(s,m,6))})("input",function(s){let m=y(e).index,c=p();return E(c.onInputMasked(m,"cantidad",6,s))}),i()(),o(8,"div",56)(9,"div",20),a(10,"Precio unit:"),i(),o(11,"div",21),a(12),v(13,"currency"),i()(),o(14,"div",56)(15,"div",20),a(16,"Subtotal:"),i(),o(17,"div",57),a(18),v(19,"currency"),i()(),o(20,"div",58)(21,"button",59),f("click",function(){let s=y(e).index,m=p();return E(m.eliminarLinea(s))}),a(22," \u2715 "),i()()()}if(r&2){let e,n=t.index,s=p();d("formGroupName",n),l(5),d("ngForOf",s.productos),l(2),d("value",s.getCantidadMasked(n)),l(5),u(" ",h(13,5,((e=s.lineas.at(n).get("precioUnit"))==null?null:e.value)||0,"COP","symbol-narrow","1.0-0")," "),l(6),u(" ",h(19,10,s.subtotal(n),"COP","symbol-narrow","1.0-0")," ")}}function qe(r,t){if(r&1&&(o(0,"option",66),a(1),i()),r&2){let e=t.$implicit;d("value",e.id_metodo_pago),l(),u(" ",e.nombre_metodo_pago," ")}}function ze(r,t){if(r&1){let e=A();o(0,"div",49)(1,"div",50)(2,"select",61)(3,"option",52),a(4,"Seleccionar m\xE9todo"),i(),g(5,qe,2,2,"option",62),i()(),o(6,"div",54)(7,"input",63),f("beforeinput",function(s){let m=y(e).index,c=p();return E(c.onBeforeInputDigits(s,m,8))})("input",function(s){let m=y(e).index,c=p();return E(c.onInputMontoMasked(m,8,s))}),i()(),o(8,"div",50),M(9,"input",64),i(),o(10,"div",58)(11,"button",65),f("click",function(){let s=y(e).index,m=p();return E(m.eliminarPago(s))}),a(12," \u2715 "),i()()()}if(r&2){let e=t.index,n=p();d("formGroupName",e),l(5),d("ngForOf",n.metodosPago),l(2),d("value",n.getMontoMasked(e))}}function Ue(r,t){if(r&1&&(o(0,"div",19)(1,"span",20),a(2,"Saldo pendiente:"),i(),o(3,"span",67),a(4),v(5,"currency"),i()()),r&2){let e=p();l(4),_(h(5,1,e.saldoPendiente,"COP","symbol-narrow","1.0-0"))}}function Re(r,t){r&1&&(o(0,"div",68),a(1," \u26A0\uFE0F Esta ser\xE1 una venta fiada "),i())}function We(r,t){r&1&&(o(0,"div",14)(1,"label",26),a(2," Cliente "),o(3,"span",69),a(4,"*"),i()(),M(5,"input",70),i())}function Xe(r,t){r&1&&(o(0,"div",71),a(1," No hay registros "),i())}function Ke(r,t){r&1&&(o(0,"th",76),a(1,"Motivo"),i())}function Qe(r,t){r&1&&(o(0,"th",81),a(1,"Acciones"),i())}function Ye(r,t){if(r&1&&(o(0,"span",97),a(1),i()),r&2){let e=p().$implicit,n=p(2);l(),u(" +",n.getProductosAdicionales(e)," m\xE1s ")}}function Je(r,t){if(r&1&&(o(0,"div",98)(1,"div",99),a(2),i(),o(3,"div",100),a(4),i()()),r&2){let e=p().$implicit,n=p(2);l(2),u(" Todos los productos (",e.total_productos,") "),l(2),u(" ",n.getProductosCompletos(e)," ")}}function Ze(r,t){r&1&&(o(0,"span",101),a(1," \u{1F5D1}\uFE0F ELIMINADA "),i())}function et(r,t){r&1&&(o(0,"span",102),a(1," PAGADA "),i())}function tt(r,t){if(r&1&&(o(0,"span",103),a(1),v(2,"currency"),i()),r&2){let e=p().$implicit;l(),u(" FIADA (",h(2,1,e.saldo_pendiente,"COP","symbol-narrow","1.0-0"),") ")}}function nt(r,t){r&1&&(o(0,"div",110),a(1," Cargando... "),i())}function it(r,t){r&1&&(o(0,"div",110),a(1," Sin abonos registrados "),i())}function ot(r,t){if(r&1&&(o(0,"div",113)(1,"div",114)(2,"span",86),a(3),v(4,"date"),i(),o(5,"span",115),a(6),v(7,"currency"),i()(),o(8,"div",116),a(9),i()()),r&2){let e=t.$implicit;l(3),_(V(4,3,e.fecha_pago,"dd/MM/yy HH:mm")),l(3),u(" ",h(7,6,e.monto,"COP","symbol-narrow","1.0-0")," "),l(3),u(" ",e.metodo_pago," ")}}function rt(r,t){if(r&1&&(o(0,"div",111),g(1,it,2,0,"div",107)(2,ot,10,11,"div",112),i()),r&2){let e=p(2).$implicit,n=p(2);l(),d("ngIf",n.getAbonos(e.id_venta).length===0),l(),d("ngForOf",n.getAbonos(e.id_venta))}}function at(r,t){if(r&1&&(o(0,"div",117)(1,"div",118)(2,"span",119),a(3,"Total pagado:"),i(),o(4,"span",120),a(5),v(6,"currency"),i()(),o(7,"div",116),a(8),i()()),r&2){let e=p(2).$implicit,n=p(2);l(5),_(h(6,2,e.total,"COP","symbol-narrow","1.0-0")),l(3),u(" ",n.getAbonos(e.id_venta).length," abono(s) ")}}function lt(r,t){if(r&1){let e=A();o(0,"span",104),f("mouseenter",function(){y(e);let s=p().$implicit,m=p(2);return E(m.onMouseEnterAbonos(s.id_venta))}),a(1," PAGADA \u2713 "),o(2,"div",105)(3,"div",106),a(4," Historial de abonos "),i(),g(5,nt,2,0,"div",107)(6,rt,3,2,"div",108)(7,at,9,7,"div",109),i()()}if(r&2){let e=p().$implicit,n=p(2);l(5),d("ngIf",n.isCarandoAbonos(e.id_venta)),l(),d("ngIf",!n.isCarandoAbonos(e.id_venta)),l(),d("ngIf",!n.isCarandoAbonos(e.id_venta)&&n.getAbonos(e.id_venta).length>0)}}function st(r,t){if(r&1&&(o(0,"span",125),a(1),v(2,"slice"),i()),r&2){let e=p(2).$implicit;l(),u(" ",e.motivo_eliminacion.length>40?se(2,1,e.motivo_eliminacion,0,40)+"...":e.motivo_eliminacion," ")}}function dt(r,t){r&1&&(o(0,"span",126),a(1," Sin especificar "),i())}function mt(r,t){if(r&1&&(o(0,"div",127),a(1),i()),r&2){let e=p(2).$implicit;l(),u(" ",e.motivo_eliminacion," ")}}function pt(r,t){if(r&1&&(o(0,"td",84)(1,"div",121),g(2,st,3,5,"span",122)(3,dt,2,0,"span",123)(4,mt,2,1,"div",124),i()()),r&2){let e=p().$implicit;l(2),d("ngIf",e.motivo_eliminacion),l(),d("ngIf",!e.motivo_eliminacion),l(),d("ngIf",e.motivo_eliminacion&&e.motivo_eliminacion.length>40)}}function ct(r,t){if(r&1&&(o(0,"span"),a(1),i()),r&2){let e=p().$implicit;l(),_(e.cliente_desc)}}function ut(r,t){r&1&&(o(0,"span",128),a(1,"-"),i())}function gt(r,t){if(r&1){let e=A();o(0,"button",132),f("click",function(){y(e);let s=p(2).$implicit,m=p(2);return E(m.abrirModalAbonos(s))}),a(1," \u{1F4B0} Abonar "),i()}}function xt(r,t){if(r&1){let e=A();o(0,"td",81)(1,"div",129),g(2,gt,2,0,"button",130),o(3,"button",131),f("click",function(){y(e);let s=p().$implicit,m=p(2);return E(m.confirmarEliminar(s.id_venta))}),a(4," Eliminar "),i()()()}if(r&2){let e=p().$implicit;l(2),d("ngIf",e.es_fiado&&e.estado==="PENDIENTE")}}function bt(r,t){if(r&1&&(o(0,"tr",82)(1,"td",76)(2,"span",83),a(3),i()(),o(4,"td",84)(5,"div",85)(6,"span",86),a(7),i(),g(8,Ye,2,1,"span",87)(9,Je,5,2,"div",88),i()(),o(10,"td",89),a(11),v(12,"date"),i(),o(13,"td",90),a(14),v(15,"currency"),i(),o(16,"td",76),g(17,Ze,2,0,"span",91)(18,et,2,0,"span",92)(19,tt,3,6,"span",93)(20,lt,8,3,"span",94),i(),g(21,pt,5,3,"td",95),o(22,"td",84),g(23,ct,2,1,"span",48)(24,ut,2,0,"span",96),i(),o(25,"td",89),a(26),i(),g(27,xt,5,1,"td",79),i()),r&2){let e=t.$implicit,n=p(2);T("bg-yellow-500/5",e.es_fiado&&e.estado==="PENDIENTE")("bg-red-500/5",n.estaEliminada(e))("hover:bg-yellow-500/10",e.es_fiado&&e.estado==="PENDIENTE"&&n.estaActiva(e))("hover:bg-surface-900/30",!e.es_fiado&&n.estaActiva(e))("hover:bg-red-500/10",n.estaEliminada(e))("opacity-70",n.estaEliminada(e)),l(3),_(e.folio),l(4),_(n.getPrimerosProductos(e)),l(),d("ngIf",n.getProductosAdicionales(e)>0),l(),d("ngIf",n.getProductosAdicionales(e)>0),l(2),_(V(12,27,e.fecha,"dd/MM/yy HH:mm")),l(3),_(h(15,30,e.total,"COP","symbol-narrow","1.0-0")),l(3),d("ngIf",n.estaEliminada(e)),l(),d("ngIf",n.estaActiva(e)&&!e.es_fiado),l(),d("ngIf",n.estaActiva(e)&&e.es_fiado&&e.estado==="PENDIENTE"),l(),d("ngIf",n.estaActiva(e)&&e.es_fiado&&e.estado==="PAGADA"),l(),d("ngIf",n.mostrarEliminadas),l(2),d("ngIf",e.cliente_desc),l(),d("ngIf",!e.cliente_desc),l(2),_(e.usuario),l(),d("ngIf",!n.mostrarEliminadas)}}function ft(r,t){if(r&1&&(o(0,"div",72)(1,"table",73)(2,"thead",74)(3,"tr",75)(4,"th",76),a(5,"Folio"),i(),o(6,"th",76),a(7,"Productos"),i(),o(8,"th",76),a(9,"Fecha"),i(),o(10,"th",77),a(11,"Total"),i(),o(12,"th",76),a(13,"Estado"),i(),g(14,Ke,2,0,"th",78),o(15,"th",76),a(16,"Cliente"),i(),o(17,"th",76),a(18,"Usuario"),i(),g(19,Qe,2,0,"th",79),i()(),o(20,"tbody"),g(21,bt,28,35,"tr",80),i()()()),r&2){let e=p();l(14),d("ngIf",e.mostrarEliminadas),l(5),d("ngIf",!e.mostrarEliminadas),l(2),d("ngForOf",e.rows)}}function vt(r,t){r&1&&(o(0,"span",69),a(1," \u26A0\uFE0F M\xEDnimo 5 caracteres "),i())}function _t(r,t){if(r&1){let e=A();o(0,"div",133),M(1,"div",134),o(2,"div",135)(3,"h3",136),a(4,"\u26A0\uFE0F Confirmar eliminaci\xF3n"),i(),o(5,"p",137),a(6,"\xBFSeguro que deseas eliminar esta venta?"),i(),o(7,"div",138)(8,"label",26),a(9," Motivo "),o(10,"span",69),a(11,"*"),i(),a(12," (obligatorio, m\xEDnimo 5 caracteres) "),i(),o(13,"textarea",139),le("ngModelChange",function(s){y(e);let m=p();return ae(m.motivoEliminacion,s)||(m.motivoEliminacion=s),E(s)}),i(),o(14,"div",140)(15,"span"),a(16),i(),g(17,vt,2,0,"span",141),i()(),o(18,"div",142)(19,"button",143),f("click",function(){y(e);let s=p();return E(s.closeConfirm())}),a(20," Cancelar "),i(),o(21,"button",144),f("click",function(){y(e);let s=p();return E(s.doEliminarConfirmado())}),a(22," \u{1F5D1}\uFE0F Eliminar venta "),i()()()()}if(r&2){let e=p();l(13),T("border-red-500",e.motivoEliminacion.trim().length<5&&e.motivoEliminacion.length>0),re("ngModel",e.motivoEliminacion),l(2),T("text-red-400",e.motivoEliminacion.trim().length<5),l(),u(" ",e.motivoEliminacion.length,"/500 caracteres "),l(),d("ngIf",e.motivoEliminacion.trim().length<5&&e.motivoEliminacion.length>0)}}function ht(r,t){if(r&1){let e=A();o(0,"app-abonos-modal",145),f("cerrar",function(s){y(e);let m=p();return E(m.cerrarModalAbonos(s))}),i()}if(r&2){let e=p();d("venta",e.ventaSeleccionada)}}var be=class r{fb=I(K);ventasSrv=I(Y);productosSrv=I(xe);metodosPagoSrv=I(J);rows=[];productos=[];metodosPago=[];okMsg="";errorMsg="";saving=!1;violations=[];violTitle="";violTimer=null;confirmOpen=!1;pendingDeleteId=null;motivoEliminacion="";mostrarModalAbonos=!1;ventaSeleccionada=null;mostrarEliminadas=!1;rowsOriginales=[];abonosCache=new Map;cargandoAbonos=new Map;static LIMITE_CANTIDAD=6;static TOPE_TOTAL=99999999;static MAX_ITEMS=200;form=this.fb.group({lineas:this.fb.array([]),pagos:this.fb.array([]),cliente_desc:[""],observaciones:[""],fecha_venta:[""]});get lineas(){return this.form.controls.lineas}get pagos(){return this.form.controls.pagos}get today(){let t=new Date,e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0"),m=String(t.getHours()).padStart(2,"0"),c=String(t.getMinutes()).padStart(2,"0");return`${e}-${n}-${s}T${m}:${c}`}ngOnInit(){this.loadProductos(),this.loadMetodosPago(),this.loadRows(),this.lineas.length===0&&this.agregarLinea(),this.form.patchValue({fecha_venta:this.today})}onlyDigits(t){return(t||"").replace(/\D/g,"")}clampDigits(t,e){return this.onlyDigits(t).slice(0,e)}withThousands(t){return t.replace(/\B(?=(\d{3})+(?!\d))/g,".")}unmask(t){let e=(t??"").toString().replace(/\D/g,"");return e?Number(e):0}onBeforeInputDigits(t,e,n){let s=t.inputType||"";if(s.startsWith("delete")||s==="historyUndo"||s==="historyRedo")return;let m=t.target,c=t.data??"",x=m.selectionStart??m.value.length,b=m.selectionEnd??m.value.length,w=(m.value.slice(0,x)||"").replace(/\D/g,""),ee=(m.value.slice(b)||"").replace(/\D/g,""),C=(String(c)||"").replace(/\D/g,"");w.length+C.length+ee.length>n&&t.preventDefault()}getCantidadMasked(t){let e=this.lineas.at(t).get("cantidad")?.value||"",n;return typeof e=="number"?n=String(Math.floor(e)):n=this.onlyDigits(String(e)),this.withThousands(n)}onInputMasked(t,e,n,s){let m=s.target,c=this.clampDigits(m.value,n),x=this.withThousands(c);m.value=x;let b=this.lineas.at(t).get(e);b&&(b.setValue(c||"",{emitEvent:!0}),b.markAsTouched())}loadProductos(){this.productosSrv.listar().subscribe({next:t=>this.productos=t||[],error:()=>this.productos=[]})}loadMetodosPago(){this.metodosPagoSrv.listar().subscribe({next:t=>this.metodosPago=t||[],error:()=>this.metodosPago=[]})}loadRows(){this.ventasSrv.listar(!0).subscribe({next:t=>{this.rowsOriginales=t||[],this.actualizarFiltroPantalla()},error:()=>{this.rows=[],this.rowsOriginales=[]}})}actualizarFiltroPantalla(){this.mostrarEliminadas?this.rows=this.rowsOriginales.filter(t=>this.estaEliminada(t)):this.rows=this.rowsOriginales.filter(t=>this.estaActiva(t))}toggleMostrarEliminadas(){this.mostrarEliminadas=!this.mostrarEliminadas,this.actualizarFiltroPantalla()}estaEliminada(t){return!t.activo||t.activo===!1||t.activo===0}estaActiva(t){return t.activo===!0||t.activo===1}crearLinea(){return this.fb.group({producto:["",[S.required]],cantidad:["",[S.required]],precioUnit:[0,[S.required]]})}agregarLinea(){this.lineas.length>=r.MAX_ITEMS||this.lineas.push(this.crearLinea())}eliminarLinea(t){this.lineas.removeAt(t)}getSelectedIds(t){let e=new Set;return this.lineas.controls.forEach((n,s)=>{if(s===t)return;let m=n.get("producto")?.value,c=Number(m);c&&e.add(c)}),e}isProductoOcupado(t,e){return this.getSelectedIds(e).has(Number(t))}onProductoChange(t){let e=this.lineas.at(t),n=Number(e.get("producto")?.value);if(this.isProductoOcupado(n,t)){e.get("producto")?.setValue(""),e.get("precioUnit")?.setValue(0),this.showError("Este producto ya est\xE1 seleccionado en otra fila.");return}let s=this.productos.find(c=>Number(c.id_producto)===n),m=Number(s?.precio_unitario??s?.precio_venta??0);e.get("precioUnit")?.setValue(m)}subtotal(t){let e=this.lineas.at(t),n=this.unmask(e.get("cantidad")?.value),s=Number(e.get("precioUnit")?.value||0);return n*s}get total(){return this.lineas.controls.reduce((t,e)=>{let n=this.unmask(e.get("cantidad")?.value),s=Number(e.get("precioUnit")?.value||0);return t+n*s},0)}crearPago(){return this.fb.group({id_metodo_pago:["",[S.required]],monto:["",[S.required,S.min(1)]],observaciones:[""]})}agregarPago(){this.pagos.push(this.crearPago())}eliminarPago(t){this.pagos.removeAt(t)}getMontoMasked(t){let e=this.pagos.at(t).get("monto")?.value||"",n;return typeof e=="number"?n=String(Math.floor(e)):n=this.onlyDigits(String(e)),this.withThousands(n)}onInputMontoMasked(t,e,n){let s=n.target,m=this.clampDigits(s.value,e),c=this.withThousands(m);s.value=c;let x=this.pagos.at(t).get("monto");x&&(x.setValue(m?Number(m):null,{emitEvent:!0}),x.markAsTouched())}get totalPagos(){return this.pagos.controls.reduce((t,e)=>{let n=this.unmask(e.get("monto")?.value);return t+n},0)}get saldoPendiente(){return Math.max(0,this.total-this.totalPagos)}get esVentaFiada(){return this.totalPagos<this.total}get requiereCliente(){return this.esVentaFiada}autoHide(t=4e3){window.setTimeout(()=>{this.okMsg="",this.errorMsg=""},t)}showOk(t){this.okMsg=t,this.errorMsg="",this.autoHide()}showError(t){this.errorMsg=t,this.okMsg="",this.autoHide()}clearViolations(){this.violTimer&&clearTimeout(this.violTimer),this.violations=[],this.violTitle=""}setViolations(t,e){this.violations=t||[],this.violTitle=e,this.violTimer&&clearTimeout(this.violTimer),this.violTimer=setTimeout(()=>this.clearViolations(),1e4)}validar(){let t=this.lineas.length;if(t<=0)return"Debes agregar al menos un producto.";if(t>r.MAX_ITEMS)return`La venta no puede tener m\xE1s de ${r.MAX_ITEMS} \xEDtems.`;let e=new Set;for(let s=0;s<t;s++){let m=this.lineas.at(s),c=Number(m.get("producto")?.value),x=this.unmask(m.get("cantidad")?.value),b=Number(m.get("precioUnit")?.value||0);if(!c)return`Debes seleccionar el producto en la fila #${s+1}.`;if(e.has(c))return`El producto de la fila #${s+1} ya fue seleccionado en otra fila.`;if(e.add(c),!(x>=1&&x<=999999))return`La cantidad de la fila #${s+1} debe estar entre 1 y 999.999.`;if(!(b>=1&&b<=99999999))return`El precio unitario de la fila #${s+1} debe estar entre 1 y 99.999.999.`}let n=this.total;if(!(n>=1&&n<=r.TOPE_TOTAL))return`El total de la venta no puede superar $ ${r.TOPE_TOTAL.toLocaleString("es-CO")}.`;for(let s=0;s<this.pagos.length;s++){let m=this.pagos.at(s),c=Number(m.get("id_metodo_pago")?.value),x=this.unmask(m.get("monto")?.value);if(!c)return`Debes seleccionar el m\xE9todo de pago en la fila #${s+1}.`;if(!(x>=1&&x<=99999999))return`El monto del pago #${s+1} debe estar entre 1 y 99.999.999.`}if(this.esVentaFiada&&!(this.form.get("cliente_desc")?.value||"").trim())return"Para ventas fiadas es obligatorio especificar el nombre del cliente.";if(!this.esVentaFiada&&this.totalPagos>this.total){let s=this.totalPagos-this.total;return`El total de pagos ($${this.totalPagos.toLocaleString("es-CO")}) excede el total de la venta ($${this.total.toLocaleString("es-CO")}) por $${s.toLocaleString("es-CO")}.`}return""}submit(){if(this.saving)return;let t=this.validar();if(t){this.showError(`\u274C ${t}`);return}let e=this.lineas.controls.map(b=>({id_producto:Number(b.get("producto")?.value),cantidad:this.unmask(b.get("cantidad")?.value),precio_unitario:Number(b.get("precioUnit")?.value||0)})),n=this.pagos.length>0?this.pagos.controls.map(b=>({id_metodo_pago:Number(b.get("id_metodo_pago")?.value),monto:this.unmask(b.get("monto")?.value),observaciones:(b.get("observaciones")?.value||"").trim()||null})):void 0,s=this.esVentaFiada&&(this.form.get("cliente_desc")?.value||"").trim()||null,m=(this.form.get("observaciones")?.value||"").trim()||null,c=this.form.get("fecha_venta")?.value||void 0,x={detalles:e};n&&n.length>0&&(x.pagos=n),s&&(x.cliente_desc=s),m&&(x.observaciones=m),c&&(x.fecha_venta=c),console.log("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501"),console.log("\u{1F4E4} BODY A ENVIAR AL BACKEND:"),console.log(JSON.stringify(x,null,2)),console.log("\u{1F4E4} Detalles:",x.detalles),console.log("\u{1F4E4} Es array?",Array.isArray(x.detalles),"| Longitud:",x.detalles?.length),console.log("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501"),this.saving=!0,this.clearViolations(),this.ventasSrv.crear(x).pipe(P(()=>{this.saving=!1,this.autoHide()})).subscribe({next:b=>{Array.isArray(b?.warnings)&&b.warnings.length>0&&console.warn("Warnings:",b.warnings),this.showOk(b?.message||`Venta registrada (ID: ${b?.venta?.id_venta??""})`),this.loadRows(),this.resetForm(),window.scrollTo({top:0,behavior:"smooth"})},error:b=>{let w=b?.error||{};if(w?.code==="STOCK_NOT_ENOUGH"&&Array.isArray(w?.items)){let ee=w.items.map(C=>({producto_id:C.producto_id,nombre:C.nombre||`#${C.producto_id}`,type:"NOT_ENOUGH",actual:C.disponible,solicitado:C.solicitado,faltan:C.deficit,resultante:(C.disponible??0)-(C.solicitado??0)}));this.setViolations(ee,"Productos sin stock suficiente:"),this.showError("\u274C No se puede registrar la venta: stock insuficiente.")}else w?.code==="MIN_STOCK_BREACH"&&Array.isArray(w?.violations)?(this.setViolations(w.violations,"Productos bajo el m\xEDnimo:"),this.showError("\u274C No se puede registrar la venta: hay productos que quedar\xEDan bajo el m\xEDnimo.")):this.showError(w?.message||w?.raw||"Error al guardar la venta.")}})}editar(t){this.showError("\u274C La funcionalidad de editar ventas no est\xE1 disponible actualmente.")}confirmarEliminar(t){this.pendingDeleteId=t??null,this.motivoEliminacion="",this.confirmOpen=!0}closeConfirm(){this.confirmOpen=!1,this.pendingDeleteId=null,this.motivoEliminacion=""}doEliminarConfirmado(){if(this.pendingDeleteId==null){this.closeConfirm();return}let t=this.motivoEliminacion.trim();if(!t||t.length<5){this.showError("\u274C El motivo de eliminaci\xF3n es obligatorio (m\xEDnimo 5 caracteres)");return}let e=this.pendingDeleteId;this.closeConfirm(),this.ventasSrv.eliminar(e,t).subscribe({next:n=>{Array.isArray(n?.warnings)&&n.warnings.length>0&&console.warn("Warnings:",n.warnings),this.showOk(n?.message||"Venta eliminada correctamente"),this.loadRows()},error:n=>{let s=n?.error||{};s?.code==="MAX_STOCK_BREACH"&&Array.isArray(s?.violations)?(this.setViolations(s.violations,"Productos que exceder\xEDan el m\xE1ximo:"),this.showError("\u274C No se puede eliminar la venta: los productos listados superar\xEDan el stock m\xE1ximo.")):this.showError(s?.message||s?.raw||"Error al eliminar venta.")}})}resetForm(){this.form.reset({lineas:[],pagos:[],cliente_desc:"",observaciones:"",fecha_venta:this.today}),this.lineas.clear(),this.pagos.clear(),this.agregarLinea(),this.clearViolations()}getPrimerosProductos(t){return!t.productos||t.productos.length===0?"-":t.productos.slice(0,2).join(", ")}getProductosAdicionales(t){return!t.productos||t.productos.length<=2?0:t.productos.length-2}getProductosCompletos(t){return!t.productos||t.productos.length===0?"Sin productos":t.productos.map(e=>`\u2022 ${e}`).join(`
`)}abrirModalAbonos(t){this.ventaSeleccionada=t,this.mostrarModalAbonos=!0}cerrarModalAbonos(t){this.mostrarModalAbonos=!1,this.ventaSeleccionada=null,t&&this.loadRows()}onMouseEnterAbonos(t){this.abonosCache.has(t)||(this.cargandoAbonos.set(t,!0),this.ventasSrv.obtenerAbonos(t).subscribe({next:e=>{this.abonosCache.set(t,e.abonos||[]),this.cargandoAbonos.set(t,!1)},error:e=>{console.error("Error al cargar abonos:",e),this.abonosCache.set(t,[]),this.cargandoAbonos.set(t,!1)}}))}getAbonos(t){return this.abonosCache.get(t)||[]}isCarandoAbonos(t){return this.cargandoAbonos.get(t)||!1}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=k({type:r,selectors:[["app-ventas"]],decls:62,vars:31,consts:[[1,"space-y-6"],[1,"text-center","text-xl","font-bold"],["class","mx-auto w-full max-w-4xl rounded-xl border border-green-500/40 bg-green-500/10 px-4 py-3 text-green-300 text-center",4,"ngIf"],["class","mx-auto w-full max-w-4xl rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-red-300 text-center",4,"ngIf"],["class","mx-auto w-full max-w-4xl rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-red-300",4,"ngIf"],[1,"mx-auto","w-full","max-w-4xl","rounded-2xl","bg-surface-800","border","border-white/5","p-6","sm:p-7"],[1,"text-lg","font-semibold","text-brand-500","mb-4"],["novalidate","",1,"space-y-4",3,"ngSubmit","formGroup"],["formArrayName","lineas",1,"space-y-3"],["class","grid gap-3 md:grid-cols-12 items-center",3,"formGroupName",4,"ngFor","ngForOf"],["type","button",1,"w-full","rounded-xl","border-2","border-dashed","border-brand-500/70","text-brand-500","font-semibold","py-3","px-5","hover:bg-brand-500","hover:text-black","transition","focus-visible:outline-none","focus-visible:ring-2","focus-visible:ring-brand-500",3,"click"],[1,"mt-4","pt-4","border-t","border-white/10"],[1,"text-center","font-semibold","whitespace-nowrap"],[1,"text-brand-500"],[1,"mt-6","pt-6","border-t","border-white/10"],[1,"text-md","font-semibold","mb-3"],["formArrayName","pagos",1,"space-y-3"],["type","button",1,"w-full","mt-3","rounded-xl","border-2","border-dashed","border-brand-500/70","text-brand-500","font-semibold","py-3","px-5","hover:bg-brand-500","hover:text-black","transition","focus-visible:outline-none","focus-visible:ring-2","focus-visible:ring-brand-500",3,"click"],[1,"mt-4","pt-4","border-t","border-white/10","space-y-2"],[1,"flex","justify-between","text-sm"],[1,"text-textc-mute"],[1,"font-semibold"],["class","flex justify-between text-sm",4,"ngIf"],["class","text-xs text-yellow-400 mt-2",4,"ngIf"],["class","mt-6 pt-6 border-t border-white/10",4,"ngIf"],[1,"mt-6","pt-6","border-t","border-white/10","grid","gap-4","md:grid-cols-2"],[1,"block","text-sm","font-semibold","mb-2"],["type","datetime-local","formControlName","fecha_venta",1,"input-datetime","w-full","rounded-xl","bg-surface-900","border","border-brand-500/50","px-4","py-3","outline-none","focus:border-brand-500","focus:ring-1","focus:ring-brand-500","text-white","font-semibold"],["type","text","placeholder","Observaciones generales (opcional)","formControlName","observaciones",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500","placeholder:text-[14px]"],[1,"mt-6","flex","items-center","gap-3"],["type","submit",1,"rounded-xl","border-2","border-dashed","border-brand-500/70","text-brand-500","font-semibold","px-5","py-3","hover:bg-brand-500","hover:text-black","transition","focus-visible:outline-none","focus-visible:ring-2","focus-visible:ring-brand-500","basis-[100%]","lg:basis-[100%]",3,"disabled"],[1,"mx-auto","w-full","max-w-5xl","mt-8"],[1,"rounded-2xl","bg-surface-800","border","border-white/5","overflow-hidden"],[1,"px-6","py-4","border-b","border-white/5","font-semibold","flex","items-center","justify-between"],[1,"flex","items-center","gap-2","cursor-pointer","font-normal","text-sm"],["type","checkbox",1,"w-4","h-4","rounded",3,"change","checked"],["class","px-6 py-10 text-center text-textc-mute",4,"ngIf"],["class","overflow-x-auto overflow-y-hidden",4,"ngIf"],["class","fixed inset-0 z-[60] flex items-center justify-center",4,"ngIf"],[3,"venta","cerrar",4,"ngIf"],[1,"mx-auto","w-full","max-w-4xl","rounded-xl","border","border-green-500/40","bg-green-500/10","px-4","py-3","text-green-300","text-center"],[1,"mx-auto","w-full","max-w-4xl","rounded-xl","border","border-red-500/40","bg-red-500/10","px-4","py-3","text-red-300","text-center"],[1,"mx-auto","w-full","max-w-4xl","rounded-xl","border","border-red-500/40","bg-red-500/10","px-4","py-3","text-red-300"],[1,"font-semibold","mb-2"],[1,"list-disc","ml-6","space-y-1"],[4,"ngFor","ngForOf"],[1,"text-white"],[1,"opacity-80"],[4,"ngIf"],[1,"grid","gap-3","md:grid-cols-12","items-center",3,"formGroupName"],[1,"md:col-span-4"],["formControlName","producto",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500",3,"change"],["value",""],[3,"value","disabled",4,"ngFor","ngForOf"],[1,"md:col-span-3"],["type","text","inputmode","numeric","autocomplete","off","placeholder","Cantidad (m\xE1x. 999.999)",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500","placeholder:text-[14px]",3,"beforeinput","input","value"],[1,"md:col-span-2","text-sm"],[1,"font-semibold","text-brand-500"],[1,"md:col-span-1","flex","justify-end"],["type","button","aria-label","Quitar producto","title","Quitar producto",1,"px-2","py-2","rounded-lg","text-pink-400","hover:text-pink-300",3,"click"],[3,"value","disabled"],["formControlName","id_metodo_pago",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500"],[3,"value",4,"ngFor","ngForOf"],["type","text","inputmode","numeric","autocomplete","off","placeholder","Monto (m\xE1x. 99.999.999)",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500","placeholder:text-[14px]",3,"beforeinput","input","value"],["type","text","placeholder","Observaciones (opcional)","formControlName","observaciones",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500","placeholder:text-[14px]"],["type","button","aria-label","Quitar pago","title","Quitar pago",1,"px-2","py-2","rounded-lg","text-pink-400","hover:text-pink-300",3,"click"],[3,"value"],[1,"font-semibold","text-yellow-400"],[1,"text-xs","text-yellow-400","mt-2"],[1,"text-red-400"],["type","text","placeholder","Nombre del cliente (obligatorio para ventas fiadas)","formControlName","cliente_desc","maxlength","200",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500","placeholder:text-[14px]"],[1,"px-6","py-10","text-center","text-textc-mute"],[1,"overflow-x-auto","overflow-y-hidden"],[1,"w-full","text-left","text-sm"],[1,"bg-surface-900/60","sticky","top-0"],[1,"border-b","border-white/5"],[1,"px-6","py-3"],[1,"px-6","py-3","text-right"],["class","px-6 py-3",4,"ngIf"],["class","px-6 py-3 text-center",4,"ngIf"],["class","border-b border-white/5 transition-colors",3,"bg-yellow-500/5","bg-red-500/5","hover:bg-yellow-500/10","hover:bg-surface-900/30","hover:bg-red-500/10","opacity-70",4,"ngFor","ngForOf"],[1,"px-6","py-3","text-center"],[1,"border-b","border-white/5","transition-colors"],[1,"font-mono","text-xs","text-brand-400"],[1,"px-6","py-3","text-sm"],[1,"relative","group","inline-block"],[1,"text-gray-300"],["class","ml-1 px-2 py-0.5 bg-brand-500/20 text-brand-400 rounded text-xs cursor-help",4,"ngIf"],["class","absolute left-0 w-80 p-3 rounded-lg bg-surface-900 border border-brand-500/30 shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 pointer-events-none -top-2 -translate-y-full",4,"ngIf"],[1,"px-6","py-3","text-sm","text-gray-400"],[1,"px-6","py-3","text-right","font-semibold"],["class","inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-red-500/20 text-red-400",4,"ngIf"],["class","inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-green-500/20 text-green-400",4,"ngIf"],["class","inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-yellow-500/20 text-yellow-400",4,"ngIf"],["class","relative group inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-green-500/20 text-green-400 cursor-help",3,"mouseenter",4,"ngIf"],["class","px-6 py-3 text-sm",4,"ngIf"],["class","text-gray-500",4,"ngIf"],[1,"ml-1","px-2","py-0.5","bg-brand-500/20","text-brand-400","rounded","text-xs","cursor-help"],[1,"absolute","left-0","w-80","p-3","rounded-lg","bg-surface-900","border","border-brand-500/30","shadow-2xl","opacity-0","invisible","group-hover:opacity-100","group-hover:visible","transition-all","duration-200","z-50","pointer-events-none","-top-2","-translate-y-full"],[1,"text-xs","font-semibold","text-brand-400","mb-2"],[1,"text-xs","text-gray-300","whitespace-pre-line","leading-relaxed","max-h-60","overflow-y-auto"],[1,"inline-flex","items-center","px-2","py-1","rounded","text-xs","font-semibold","bg-red-500/20","text-red-400"],[1,"inline-flex","items-center","px-2","py-1","rounded","text-xs","font-semibold","bg-green-500/20","text-green-400"],[1,"inline-flex","items-center","px-2","py-1","rounded","text-xs","font-semibold","bg-yellow-500/20","text-yellow-400"],[1,"relative","group","inline-flex","items-center","px-2","py-1","rounded","text-xs","font-semibold","bg-green-500/20","text-green-400","cursor-help",3,"mouseenter"],[1,"absolute","left-0","w-80","p-3","rounded-lg","bg-surface-900","border","border-green-500/30","shadow-2xl","opacity-0","invisible","group-hover:opacity-100","group-hover:visible","transition-all","duration-200","z-50","pointer-events-none","-top-2","-translate-y-full"],[1,"text-xs","font-semibold","text-green-400","mb-2"],["class","text-xs text-gray-400 italic",4,"ngIf"],["class","space-y-2 max-h-48 overflow-y-auto",4,"ngIf"],["class","border-t border-white/10 mt-2 pt-2 space-y-1",4,"ngIf"],[1,"text-xs","text-gray-400","italic"],[1,"space-y-2","max-h-48","overflow-y-auto"],["class","border-b border-white/5 pb-2",4,"ngFor","ngForOf"],[1,"border-b","border-white/5","pb-2"],[1,"flex","justify-between","items-start","gap-2","text-xs"],[1,"text-green-400","font-semibold","whitespace-nowrap"],[1,"text-[10px]","text-gray-500"],[1,"border-t","border-white/10","mt-2","pt-2","space-y-1"],[1,"flex","justify-between","items-center","text-xs"],[1,"text-gray-400"],[1,"text-green-400","font-semibold"],[1,"relative","group","inline-block","w-full"],["class","text-red-300 truncate max-w-xs inline-block cursor-help",4,"ngIf"],["class","text-gray-500 italic",4,"ngIf"],["class",`absolute left-0 top-full mt-1 w-64 p-3 rounded-lg bg-red-900/80 border border-red-500/50
                                                opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50
                                                pointer-events-none text-xs text-red-100`,4,"ngIf"],[1,"text-red-300","truncate","max-w-xs","inline-block","cursor-help"],[1,"text-gray-500","italic"],[1,"absolute","left-0","top-full","mt-1","w-64","p-3","rounded-lg","bg-red-900/80","border","border-red-500/50","opacity-0","invisible","group-hover:opacity-100","group-hover:visible","transition-all","duration-200","z-50","pointer-events-none","text-xs","text-red-100"],[1,"text-gray-500"],[1,"flex","items-center","justify-center","gap-2"],["class","px-3 py-1.5 text-xs font-semibold bg-brand-500/20 text-brand-400 rounded-lg hover:bg-brand-500/30 transition","type","button",3,"click",4,"ngIf"],["type","button","title","Eliminar venta",1,"text-red-400","hover:text-red-300","font-semibold","text-xs","transition",3,"click"],["type","button",1,"px-3","py-1.5","text-xs","font-semibold","bg-brand-500/20","text-brand-400","rounded-lg","hover:bg-brand-500/30","transition",3,"click"],[1,"fixed","inset-0","z-[60]","flex","items-center","justify-center"],[1,"absolute","inset-0","bg-black/60"],[1,"relative","z-[61]","w-full","max-w-md","rounded-2xl","bg-surface-800","border","border-white/10","p-6","shadow-xl"],[1,"text-lg","font-semibold","mb-2"],[1,"text-sm","text-textc-mute"],[1,"mt-4"],["placeholder","Ej: Error de registro, venta duplicada, cliente rechaz\xF3...","rows","3","maxlength","500",1,"w-full","rounded-lg","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-red-500","text-sm","resize-none",3,"ngModelChange","ngModel"],[1,"flex","justify-between","text-xs","mt-1"],["class","text-red-400",4,"ngIf"],[1,"mt-6","flex","gap-3","justify-end"],["type","button",1,"rounded-xl","border","border-white/10","px-4","py-2","hover:bg-white/5",3,"click"],["type","button",1,"rounded-xl","bg-red-500/90","text-black","font-semibold","px-4","py-2","hover:bg-red-400","transition",3,"click"],[3,"cerrar","venta"]],template:function(e,n){e&1&&(o(0,"div",0)(1,"h2",1),a(2," Registrar Venta "),i(),g(3,Ne,2,1,"div",2)(4,Oe,2,1,"div",3)(5,Le,5,2,"div",4),o(6,"section",5)(7,"h3",6),a(8," Registrar venta "),i(),o(9,"form",7),f("ngSubmit",function(){return n.submit()}),o(10,"div",8),g(11,He,23,15,"div",9),i(),o(12,"button",10),f("click",function(){return n.agregarLinea()}),a(13," + Agregar producto "),i(),o(14,"div",11)(15,"div",12),a(16," Total productos: "),o(17,"span",13),a(18),v(19,"currency"),i()()(),o(20,"div",14)(21,"h4",15),a(22,"M\xE9todos de pago"),i(),o(23,"div",16),g(24,ze,13,3,"div",9),i(),o(25,"button",17),f("click",function(){return n.agregarPago()}),a(26," + Agregar m\xE9todo de pago "),i(),o(27,"div",18)(28,"div",19)(29,"span",20),a(30,"Total pagado:"),i(),o(31,"span",21),a(32),v(33,"currency"),i()(),g(34,Ue,6,6,"div",22)(35,Re,2,0,"div",23),i()(),g(36,We,6,0,"div",24),o(37,"div",25)(38,"div")(39,"label",26),a(40,"Fecha y hora de venta"),i(),M(41,"input",27),i(),o(42,"div")(43,"label",26),a(44,"Observaciones"),i(),M(45,"input",28),i()(),o(46,"div",29)(47,"button",30),a(48),i()()()(),o(49,"section",31)(50,"div",32)(51,"div",33)(52,"span"),a(53,"Ventas registradas"),i(),o(54,"label",34)(55,"input",35),f("change",function(){return n.toggleMostrarEliminadas()}),i(),o(56,"span"),a(57),i()()(),g(58,Xe,2,0,"div",36)(59,ft,22,3,"div",37),i()(),g(60,_t,23,7,"div",38)(61,ht,1,1,"app-abonos-modal",39),i()),e&2&&(l(3),d("ngIf",n.okMsg),l(),d("ngIf",n.errorMsg),l(),d("ngIf",n.violations.length>0),l(4),d("formGroup",n.form),l(2),d("ngForOf",n.lineas.controls),l(7),_(h(19,21,n.total,"COP","symbol-narrow","1.0-0")),l(6),d("ngForOf",n.pagos.controls),l(8),_(h(33,26,n.totalPagos,"COP","symbol-narrow","1.0-0")),l(2),d("ngIf",n.esVentaFiada),l(),d("ngIf",n.esVentaFiada),l(),d("ngIf",n.requiereCliente),l(11),d("disabled",n.saving),l(),u(" ",n.saving?"Guardando...":"Registrar venta"," "),l(7),d("checked",n.mostrarEliminadas),l(),T("text-red-400",n.mostrarEliminadas),l(),u(" ",n.mostrarEliminadas?"\u{1F5D1}\uFE0F Mostrando eliminadas":"\u{1F4CB} Mostrar eliminadas"," "),l(),d("ngIf",n.rows.length===0),l(),d("ngIf",n.rows.length>0),l(),d("ngIf",n.confirmOpen),l(),d("ngIf",n.mostrarModalAbonos&&n.ventaSeleccionada))},dependencies:[G,O,F,Q,q,W,X,L,R,j,H,ue,z,U,pe,ce,ge,me,Z,de,B,$],styles:["[_nghost-%COMP%]{display:block}.input-datetime[_ngcontent-%COMP%]{color:#fff}.input-datetime[_ngcontent-%COMP%]::placeholder{color:#ffffff80}.input-datetime[_ngcontent-%COMP%]::-webkit-calendar-picker-indicator{filter:brightness(1.2) invert(.8);cursor:pointer}"]})};export{be as Ventas};
