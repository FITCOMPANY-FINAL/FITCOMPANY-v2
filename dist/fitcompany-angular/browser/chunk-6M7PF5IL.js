import{b as A,c,d as k,e as R,g as P,h as F,k as $,l as V,m as D,n as L,p as q,r as B}from"./chunk-R2MBKBQG.js";import{a as U}from"./chunk-Y5NMKK7J.js";import{B as I,Ca as S,Ga as m,Mb as N,Nb as T,Pa as y,R as w,Sa as l,Sb as M,Ta as i,Ua as t,Va as f,X as g,Y as x,Ya as v,Yb as O,Za as b,_a as p,a as E,eb as n,fb as u,gb as _,ib as C,ta as a}from"./chunk-4VXNIXON.js";function G(o,e){if(o&1&&(i(0,"div",32),n(1),t()),o&2){let r=p();a(),_(" ",r.okMsg," ")}}function K(o,e){if(o&1&&(i(0,"div",33),n(1),t()),o&2){let r=p();a(),_(" ",r.errorMsg," ")}}function j(o,e){if(o&1&&(i(0,"div",34),n(1),t()),o&2){let r=p();a(),_(" ",r.errorMsgInline," ")}}function H(o,e){if(o&1&&(i(0,"option",35),n(1),t()),o&2){let r=e.$implicit;l("value",r.id),a(),u(r.nombre||r.descripcion||"-")}}function Z(o,e){o&1&&(i(0,"span",10),n(1,"*"),t())}function J(o,e){o&1&&(i(0,"span",36),n(1,"(dejar en blanco si no cambia)"),t())}function Q(o,e){if(o&1&&(i(0,"option",35),n(1),t()),o&2){let r=e.$implicit;l("value",r.id_rol),a(),u(r.nombre_rol)}}function W(o,e){if(o&1){let r=v();i(0,"button",37),b("click",function(){g(r);let d=p();return x(d.cancelarEdicion())}),n(1," Cancelar "),t()}}function X(o,e){o&1&&(i(0,"div",38),n(1," Cargando... "),t())}function Y(o,e){o&1&&(i(0,"div",38),n(1," No hay registros "),t())}function ee(o,e){if(o&1){let r=v();i(0,"tr",42)(1,"td",43),n(2),t(),i(3,"td",43),n(4),t(),i(5,"td",43),n(6),t(),i(7,"td",43),n(8),t(),i(9,"td",45)(10,"button",46),b("click",function(){let d=g(r).$implicit,h=p(2);return x(h.editar(d))}),n(11,"Editar"),t(),i(12,"button",47),b("click",function(){let d=g(r).$implicit,h=p(2);return x(h.confirmarEliminar(d))}),n(13,"Eliminar"),t()()()}if(o&2){let r=e.$implicit;a(2),u(r.identificacion),a(2),C("",r.nombre," ",r.apellido1," ",r.apellido2||""),a(2),u(r.correo),a(2),u(r.rol_nombre||"-")}}function te(o,e){if(o&1&&(i(0,"div",39)(1,"table",40)(2,"thead",41)(3,"tr",42)(4,"th",43),n(5,"Identificaci\xF3n"),t(),i(6,"th",43),n(7,"Nombre completo"),t(),i(8,"th",43),n(9,"Correo"),t(),i(10,"th",43),n(11,"Rol"),t(),i(12,"th",43),n(13,"Acciones"),t()()(),i(14,"tbody"),m(15,ee,14,6,"tr",44),t()()()),o&2){let r=p();a(15),l("ngForOf",r.rows)}}function ie(o,e){if(o&1){let r=v();i(0,"div",48)(1,"div",49)(2,"h3",50),n(3),t(),i(4,"p",51),n(5),t(),i(6,"div",52)(7,"button",53),b("click",function(){g(r);let d=p();return x(d.closeConfirm())}),n(8,"Cancelar"),t(),i(9,"button",54),b("click",function(){g(r);let d=p();return x(d.doEliminarConfirmado())}),n(10,"Eliminar"),t()()()()}if(o&2){let r=p();a(3),u(r.confirmTitle),a(2),u(r.confirmMessage)}}var z=class o{fb=w(q);http=w(O);API=U.apiBaseUrl;rows=[];roles=[];tiposId=[];loadingList=!1;saving=!1;okMsg="";errorMsg="";errorMsgInline="";editando=!1;editingPK=null;confirmOpen=!1;confirmTitle="";confirmMessage="";pendingDelete=null;PATRON_NOMBRE=/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s\-.]+$/;PATRON_IDENT=/^[A-Za-z0-9.\-]+$/;PATRON_EMAIL=/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;form=this.fb.nonNullable.group({tipo_identificacion:["",[c.required]],identificacion:["",[c.required,c.pattern(this.PATRON_IDENT)]],nombre:["",[c.required,c.pattern(this.PATRON_NOMBRE)]],apellido1:["",[c.required,c.pattern(this.PATRON_NOMBRE)]],apellido2:["",[c.pattern(this.PATRON_NOMBRE)]],correo:["",[c.required,c.pattern(this.PATRON_EMAIL)]],contrasennia:[""],id_rol:["",[c.required]]});ngOnInit(){this.loadCombos(),this.loadData()}autoHide(e=4e3){window.setTimeout(()=>{this.okMsg="",this.errorMsg="",this.errorMsgInline=""},e)}showOk(e){this.okMsg=e,this.errorMsg="",this.errorMsgInline="",this.autoHide()}showError(e){this.errorMsg=e,this.okMsg="",this.errorMsgInline="",this.autoHide()}showInline(e){this.errorMsgInline=e,this.okMsg="",this.errorMsg="",this.autoHide()}loadCombos(){this.http.get(`${this.API}/roles`).subscribe({next:e=>this.roles=e||[],error:()=>this.roles=[]}),this.http.get(`${this.API}/tipos-identificacion`).subscribe({next:e=>this.tiposId=e||[],error:()=>this.tiposId=[]})}loadData(){this.loadingList=!0,this.http.get(`${this.API}/usuarios`).subscribe({next:e=>{this.rows=e||[],this.loadingList=!1},error:e=>{console.error("Error al cargar usuarios:",e),this.rows=[],this.loadingList=!1,this.showError("Error al cargar los usuarios.")}})}S(e){return String(e??"").trim()}submit(){if(this.saving)return;let e={tipo_identificacion:this.S(this.form.value.tipo_identificacion),identificacion:this.S(this.form.value.identificacion),nombre:this.S(this.form.value.nombre).replace(/\s+/g," "),apellido1:this.S(this.form.value.apellido1).replace(/\s+/g," "),apellido2:this.S(this.form.value.apellido2).replace(/\s+/g," "),correo:this.S(this.form.value.correo).toLowerCase(),contrasennia:this.form.value.contrasennia??"",id_rol:Number(this.form.value.id_rol)};if(!e.tipo_identificacion)return this.showInline("El tipo de identificaci\xF3n es obligatorio.");if(!e.identificacion)return this.showInline("La identificaci\xF3n es obligatoria.");if(!this.PATRON_IDENT.test(e.identificacion))return this.showInline("La identificaci\xF3n solo admite letras, n\xFAmeros, puntos o guiones.");if(!e.nombre||!this.PATRON_NOMBRE.test(e.nombre))return this.showInline("El nombre solo puede contener letras, espacios, guiones y puntos.");if(!e.apellido1||!this.PATRON_NOMBRE.test(e.apellido1))return this.showInline("El apellido 1 solo puede contener letras, espacios, guiones y puntos.");if(e.apellido2&&!this.PATRON_NOMBRE.test(e.apellido2))return this.showInline("El apellido 2 solo puede contener letras, espacios, guiones y puntos.");if(!e.correo||!this.PATRON_EMAIL.test(e.correo))return this.showInline("Formato de correo inv\xE1lido.");if(!this.editando&&(!e.contrasennia||String(e.contrasennia).length<3))return this.showInline("La contrase\xF1a debe tener al menos 3 caracteres.");if(!e.id_rol)return this.showInline("Debes seleccionar un rol.");this.saving=!0,this.okMsg=this.errorMsg=this.errorMsgInline="";let r=E({tipo_identificacion:e.tipo_identificacion,identificacion:e.identificacion,nombre:e.nombre,apellido1:e.apellido1,apellido2:e.apellido2||void 0,correo:e.correo,id_rol:e.id_rol},this.editando?e.contrasennia?{contrasennia:e.contrasennia}:{}:{contrasennia:e.contrasennia});(this.editando&&this.editingPK?this.http.put(`${this.API}/usuarios/${encodeURIComponent(this.editingPK.tipo)}/${encodeURIComponent(this.editingPK.id)}`,r):this.http.post(`${this.API}/usuarios`,r)).pipe(I(()=>this.saving=!1)).subscribe({next:d=>{this.showOk(d?.message||(this.editando?"Usuario actualizado.":"Usuario creado.")),this.loadData(),this.resetForm(),window.scrollTo({top:0,behavior:"smooth"})},error:d=>{let h=d?.error?.message||"Error al guardar el usuario.";d?.status===400||d?.status===409?this.showInline(h):this.showError(h)}})}editar(e){this.editando=!0,this.editingPK={tipo:String(e.tipo_identificacion),id:String(e.identificacion)},this.form.patchValue({tipo_identificacion:String(e.tipo_identificacion??""),identificacion:String(e.identificacion??""),nombre:e.nombre??"",apellido1:e.apellido1??"",apellido2:e.apellido2??"",correo:e.correo??"",contrasennia:"",id_rol:String(e.id_rol??"")}),window.scrollTo({top:0,behavior:"smooth"})}cancelarEdicion(){this.resetForm()}confirmarEliminar(e){this.pendingDelete={tipo:String(e.tipo_identificacion),id:String(e.identificacion)},this.confirmTitle="Confirmar eliminaci\xF3n",this.confirmMessage=`\xBFSeguro que deseas eliminar al usuario ${e.nombre} ${e.apellido1}?`,this.confirmOpen=!0}closeConfirm(){this.confirmOpen=!1,this.confirmTitle=this.confirmMessage=""}doEliminarConfirmado(){let e=this.pendingDelete;this.pendingDelete=null,this.closeConfirm(),e&&this.http.delete(`${this.API}/usuarios/${encodeURIComponent(e.tipo)}/${encodeURIComponent(e.id)}`).subscribe({next:r=>{this.showOk(r?.message||"Usuario eliminado."),this.loadData()},error:r=>{this.showError(r?.error?.message||"No se pudo eliminar el usuario.")}})}resetForm(){this.editando=!1,this.editingPK=null,this.form.reset({tipo_identificacion:"",identificacion:"",nombre:"",apellido1:"",apellido2:"",correo:"",contrasennia:"",id_rol:""})}static \u0275fac=function(r){return new(r||o)};static \u0275cmp=S({type:o,selectors:[["app-usuarios"]],decls:75,vars:17,consts:[[1,"space-y-6"],[1,"text-center","text-xl","font-bold"],["class","mb-4 p-3 text-center border border-lime-400 rounded bg-[#222] text-white",4,"ngIf"],["class","mb-4 p-3 text-center border border-red-500 rounded bg-[#222] text-red-300",4,"ngIf"],[1,"mx-auto","w-full","max-w-3xl","rounded-2xl","bg-surface-800","border","border-white/5","p-6","sm:p-7"],[1,"text-lg","font-semibold","text-brand-500","mb-4"],["class","mb-3 p-2 text-sm rounded bg-[#2a2a2a] border border-red-500 text-red-300",4,"ngIf"],[1,"space-y-5",3,"ngSubmit","formGroup"],[1,"grid","gap-4","sm:grid-cols-2"],[1,"block","text-sm","mb-1"],[1,"text-brand-500"],["formControlName","tipo_identificacion",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500"],["value",""],[3,"value",4,"ngFor","ngForOf"],["type","text","formControlName","identificacion","placeholder","N\xFAmero de documento","autocomplete","off",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500","placeholder:text-sm"],["type","text","formControlName","nombre","placeholder","Ej: Laura","autocomplete","off",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500","placeholder:text-sm"],["type","text","formControlName","apellido1","placeholder","Ej: G\xF3mez","autocomplete","off",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500","placeholder:text-sm"],["type","text","formControlName","apellido2","placeholder","Opcional","autocomplete","off",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500","placeholder:text-sm"],["type","email","formControlName","correo","placeholder","tucorreo@dominio.com","autocomplete","email",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500","placeholder:text-sm"],["class","text-brand-500",4,"ngIf"],["class","text-textc-mute text-xs",4,"ngIf"],["type","password","formControlName","contrasennia","placeholder","\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022","autocomplete","new-password",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500","placeholder:text-sm"],["formControlName","id_rol",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500"],[1,"flex","items-center","gap-3"],["type","submit",1,"w-full","rounded-xl","border-2","border-dashed","border-brand-500/70","text-brand-500","font-semibold","py-3","hover:bg-brand-500","hover:text-black","transition","focus-visible:outline-none","focus-visible:ring-2","focus-visible:ring-brand-500","disabled:opacity-60",3,"disabled"],["type","button","class",`rounded-xl border border-white/15 px-5 py-3 text-white hover:bg-white/5 transition
                       focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/20`,3,"click",4,"ngIf"],[1,"mx-auto","w-full","max-w-5xl"],[1,"rounded-2xl","bg-surface-800","border","border-white/5","overflow-hidden"],[1,"px-6","py-4","border-b","border-white/5","font-semibold"],["class","px-6 py-10 text-center text-textc-mute",4,"ngIf"],["class","overflow-x-auto",4,"ngIf"],["class","fixed inset-0 bg-black/50 grid place-items-center z-50",4,"ngIf"],[1,"mb-4","p-3","text-center","border","border-lime-400","rounded","bg-[#222]","text-white"],[1,"mb-4","p-3","text-center","border","border-red-500","rounded","bg-[#222]","text-red-300"],[1,"mb-3","p-2","text-sm","rounded","bg-[#2a2a2a]","border","border-red-500","text-red-300"],[3,"value"],[1,"text-textc-mute","text-xs"],["type","button",1,"rounded-xl","border","border-white/15","px-5","py-3","text-white","hover:bg-white/5","transition","focus-visible:outline-none","focus-visible:ring-2","focus-visible:ring-white/20",3,"click"],[1,"px-6","py-10","text-center","text-textc-mute"],[1,"overflow-x-auto"],[1,"w-full","text-left","text-sm"],[1,"bg-surface-900/60"],[1,"border-b","border-white/5"],[1,"px-6","py-3"],["class","border-b border-white/5",4,"ngFor","ngForOf"],[1,"px-6","py-3","whitespace-nowrap"],["type","button",1,"text-brand-500","hover:text-brand-600","mr-3",3,"click"],["type","button",1,"text-red-400","hover:text-red-300",3,"click"],[1,"fixed","inset-0","bg-black/50","grid","place-items-center","z-50"],[1,"bg-surface-800","border","border-white/10","rounded-2xl","p-6","w-full","max-w-md"],[1,"font-semibold","mb-2"],[1,"text-sm","text-textc-mute","mb-5",2,"white-space","pre-line"],[1,"flex","gap-3","justify-end"],["type","button",1,"px-4","py-2","rounded","border","border-white/15",3,"click"],["type","button",1,"px-4","py-2","rounded","bg-red-500","text-black",3,"click"]],template:function(r,s){r&1&&(i(0,"div",0)(1,"h2",1),n(2,"Gesti\xF3n de Usuarios"),t(),m(3,G,2,1,"div",2)(4,K,2,1,"div",3),i(5,"section",4)(6,"h3",5),n(7),t(),m(8,j,2,1,"div",6),i(9,"form",7),b("ngSubmit",function(){return s.submit()}),i(10,"div",8)(11,"div")(12,"label",9),n(13,"Tipo identificaci\xF3n "),i(14,"span",10),n(15,"*"),t()(),i(16,"select",11)(17,"option",12),n(18,"Seleccionar\u2026"),t(),m(19,H,2,2,"option",13),t()(),i(20,"div")(21,"label",9),n(22,"Identificaci\xF3n "),i(23,"span",10),n(24,"*"),t()(),f(25,"input",14),t(),i(26,"div")(27,"label",9),n(28,"Nombre "),i(29,"span",10),n(30,"*"),t()(),f(31,"input",15),t(),i(32,"div")(33,"label",9),n(34,"Apellido 1 "),i(35,"span",10),n(36,"*"),t()(),f(37,"input",16),t(),i(38,"div")(39,"label",9),n(40,"Apellido 2"),t(),f(41,"input",17),t(),i(42,"div")(43,"label",9),n(44,"Correo "),i(45,"span",10),n(46,"*"),t()(),f(47,"input",18),t(),i(48,"div")(49,"label",9),n(50," Contrase\xF1a "),m(51,Z,2,0,"span",19)(52,J,2,0,"span",20),t(),f(53,"input",21),t(),i(54,"div")(55,"label",9),n(56,"Rol "),i(57,"span",10),n(58,"*"),t()(),i(59,"select",22)(60,"option",12),n(61,"Seleccionar rol"),t(),m(62,Q,2,2,"option",13),t()()(),i(63,"div",23)(64,"button",24),n(65),t(),m(66,W,2,0,"button",25),t()()(),i(67,"section",26)(68,"div",27)(69,"div",28),n(70,"Listado"),t(),m(71,X,2,0,"div",29)(72,Y,2,0,"div",29)(73,te,16,1,"div",30),t()(),m(74,ie,11,2,"div",31),t()),r&2&&(a(3),l("ngIf",s.okMsg),a(),l("ngIf",s.errorMsg),a(3),_(" ",s.editando?"Editar usuario":"Agregar usuario"," "),a(),l("ngIf",s.errorMsgInline),a(),l("formGroup",s.form),a(10),l("ngForOf",s.tiposId),a(32),l("ngIf",!s.editando),a(),l("ngIf",s.editando),a(),y("required",s.editando?null:""),a(9),l("ngForOf",s.roles),a(2),l("disabled",s.saving||s.form.invalid),a(),_(" ",s.saving?"Guardando\u2026":s.editando?"Actualizar":"Agregar"," "),a(),l("ngIf",s.editando),a(5),l("ngIf",s.loadingList),a(),l("ngIf",!s.loadingList&&s.rows.length===0),a(),l("ngIf",!s.loadingList&&s.rows.length>0),a(),l("ngIf",s.confirmOpen))},dependencies:[M,N,T,B,P,D,L,A,V,k,R,F,$],encapsulation:2})};export{z as Usuarios};
