import{a as J,b as K,c as _}from"./chunk-OLAEHZKR.js";import{b as A,c as D,d as k,e as L,f as G,g as $,h as z,k as B,l as U,m as W,n as j,p as q,q as H,r as Y}from"./chunk-R2MBKBQG.js";import"./chunk-Y5NMKK7J.js";import{Ca as I,Ga as h,Mb as M,Nb as X,Qb as O,R as F,Sa as d,Sb as N,Ta as i,Ua as t,Va as E,X as x,Y as g,Ya as y,Za as v,_a as m,db as w,eb as o,fb as b,gb as f,hb as R,kb as P,lb as V,mb as T,sb as C,ta as a,vb as S}from"./chunk-4VXNIXON.js";function ae(l,r){if(l&1&&(i(0,"div",10),o(1),t()),l&2){let e=m();a(),f(" ",e.errorMsg," ")}}function ne(l,r){if(l&1&&(i(0,"div",10),o(1),t()),l&2){let e=m();a(),f(" ",e.errorFecha," ")}}function le(l,r){if(l&1&&(i(0,"option",19),o(1),t()),l&2){let e=r.$implicit;d("value",e.value),a(),f(" ",e.label," ")}}function se(l,r){if(l&1){let e=y();i(0,"div",11)(1,"div",12)(2,"label",13),o(3,"Per\xEDodo"),t(),i(4,"select",14),v("change",function(){x(e);let s=m();return g(s.onPeriodoChange())}),h(5,le,2,2,"option",15),t()(),i(6,"div",16)(7,"button",17),o(8),t(),i(9,"button",18),v("click",function(){x(e);let s=m();return g(s.exportarAExcel())}),o(10," Exportar Excel "),t()()()}if(l&2){let e=m();a(5),d("ngForOf",e.periodos),a(2),d("disabled",e.loading),a(),f(" ",e.loading?"Cargando...":"Cargar Datos"," "),a(),d("disabled",!e.datos||e.loading)}}function de(l,r){if(l&1&&(i(0,"option",19),o(1),t()),l&2){let e=r.$implicit;d("value",e.value),a(),f(" ",e.label," ")}}function ce(l,r){if(l&1){let e=y();i(0,"div",20)(1,"div")(2,"label",13),o(3,"Per\xEDodo"),t(),i(4,"select",14),v("change",function(){x(e);let s=m();return g(s.onPeriodoChange())}),h(5,de,2,2,"option",15),t()(),i(6,"div")(7,"label",13),o(8,"Fecha inicio"),t(),i(9,"input",21),v("change",function(){x(e);let s=m();return g(s.onFechaChange())}),t()(),i(10,"div")(11,"label",13),o(12,"Fecha fin"),t(),i(13,"input",22),v("change",function(){x(e);let s=m();return g(s.onFechaChange())}),t()(),i(14,"div",23)(15,"button",17),o(16),t(),i(17,"button",18),v("click",function(){x(e);let s=m();return g(s.exportarAExcel())}),o(18," Exportar Excel "),t()()()}if(l&2){let e,n,s,c,p=m();a(5),d("ngForOf",p.periodos),a(4),w("border-red-500",((e=p.form.get("fecha_inicio"))==null?null:e.invalid)&&((e=p.form.get("fecha_inicio"))==null?null:e.touched)),a(4),w("border-red-500",((n=p.form.get("fecha_fin"))==null?null:n.invalid)&&((n=p.form.get("fecha_fin"))==null?null:n.touched)),d("min",(s=p.form.get("fecha_inicio"))==null?null:s.value),a(2),d("disabled",p.loading||p.errorFecha!==""||!((c=p.form.get("fecha_inicio"))!=null&&c.value)||!((c=p.form.get("fecha_fin"))!=null&&c.value)||((c=p.form.get("fecha_fin"))==null?null:c.hasError("fechaAnterior"))),a(),f(" ",p.loading?"Cargando...":"Cargar Datos"," "),a(),d("disabled",!p.datos||p.loading)}}function pe(l,r){l&1&&(i(0,"div",44),o(1," No hay compras en el per\xEDodo seleccionado "),t())}function me(l,r){if(l&1&&(i(0,"tr",45)(1,"td",46),o(2),t(),i(3,"td",47),o(4),t(),i(5,"td",48),o(6),C(7,"currency"),t()()),l&2){let e=r.$implicit,n=m(3);a(2),b(n.formatearFecha(e.fecha)),a(2),b(e.cantidad),a(2),f(" ",S(7,3,e.total,"COP","symbol-narrow","1.0-0")," ")}}function fe(l,r){if(l&1&&(i(0,"div",37)(1,"table",38)(2,"colgroup"),E(3,"col",39)(4,"col",39)(5,"col",39),t(),i(6,"thead")(7,"tr",40)(8,"th",41),o(9,"Fecha"),t(),i(10,"th",42),o(11,"Cantidad"),t(),i(12,"th",42),o(13,"Total"),t()()(),i(14,"tbody"),h(15,me,8,8,"tr",43),t()()()),l&2){let e=m(2);a(15),d("ngForOf",e.comprasPorDiaFiltradas)}}function ue(l,r){if(l&1&&(i(0,"tr",45)(1,"td",46),o(2),t(),i(3,"td",47),o(4),t(),i(5,"td",48),o(6),C(7,"currency"),t()()),l&2){let e=r.$implicit;a(2),b(e.nombre),a(2),b(e.unidades),a(2),f(" ",S(7,3,e.total,"COP","symbol-narrow","1.0-0")," ")}}function he(l,r){if(l&1&&(i(0,"tr",45)(1,"td",46),o(2),t(),i(3,"td",47),o(4),t(),i(5,"td",48),o(6),C(7,"currency"),t()()),l&2){let e=r.$implicit;a(2),b(e.nombre),a(2),b(e.compras),a(2),f(" ",S(7,3,e.total,"COP","symbol-narrow","1.0-0")," ")}}function _e(l,r){if(l&1){let e=y();i(0,"div",0)(1,"section",3)(2,"h3",4),o(3,"Resumen General"),t(),i(4,"div",20)(5,"div",24)(6,"div",25),o(7,"Total Compras"),t(),i(8,"div",26),o(9),C(10,"currency"),t()(),i(11,"div",24)(12,"div",25),o(13,"Cantidad de Compras"),t(),i(14,"div",27),o(15),t()(),i(16,"div",24)(17,"div",25),o(18,"Compra Promedio"),t(),i(19,"div",27),o(20),C(21,"currency"),t()(),i(22,"div",24)(23,"div",25),o(24,"Per\xEDodo"),t(),i(25,"div",28),o(26),t()()()(),i(27,"section",3)(28,"div",29)(29,"h3",30),o(30,"Compras por D\xEDa"),t(),i(31,"div",31)(32,"label",25),o(33,"Mostrar:"),t(),i(34,"select",32),T("ngModelChange",function(s){x(e);let c=m();return V(c.vistaComprasPorDia,s)||(c.vistaComprasPorDia=s),g(s)}),i(35,"option",33),o(36,"Solo d\xEDas con compras"),t(),i(37,"option",34),o(38,"Todos los d\xEDas"),t()()()(),h(39,pe,2,0,"div",35)(40,fe,16,1,"div",36),t(),i(41,"section",3)(42,"h3",4),o(43,"Top 5 Productos M\xE1s Comprados"),t(),i(44,"div",37)(45,"table",38)(46,"colgroup"),E(47,"col",39)(48,"col",39)(49,"col",39),t(),i(50,"thead")(51,"tr",40)(52,"th",41),o(53,"Producto"),t(),i(54,"th",42),o(55,"Unidades"),t(),i(56,"th",42),o(57,"Total"),t()()(),i(58,"tbody"),h(59,ue,8,8,"tr",43),t()()()(),i(60,"section",3)(61,"h3",4),o(62,"Compras por Usuario"),t(),i(63,"div",37)(64,"table",38)(65,"colgroup"),E(66,"col",39)(67,"col",39)(68,"col",39),t(),i(69,"thead")(70,"tr",40)(71,"th",41),o(72,"Usuario"),t(),i(73,"th",42),o(74,"Cantidad Compras"),t(),i(75,"th",42),o(76,"Total Comprado"),t()()(),i(77,"tbody"),h(78,he,8,8,"tr",43),t()()()()()}if(l&2){let e=m();a(9),f(" ",S(10,10,e.datos.resumen.total_compras,"COP","symbol-narrow","1.0-0")," "),a(6),b(e.datos.resumen.cantidad_compras),a(5),f(" ",S(21,15,e.datos.resumen.compra_promedio,"COP","symbol-narrow","1.0-0")," "),a(6),R(" ",e.formatearFecha(e.datos.periodo.fecha_inicio)," - ",e.formatearFecha(e.datos.periodo.fecha_fin)," "),a(8),P("ngModel",e.vistaComprasPorDia),a(5),d("ngIf",e.comprasPorDiaFiltradas.length===0),a(),d("ngIf",e.comprasPorDiaFiltradas.length>0),a(19),d("ngForOf",e.datos.productos_mas_comprados),a(19),d("ngForOf",e.datos.usuarios)}}function xe(l,r){l&1&&(i(0,"div",49)(1,"div",50),o(2,"Cargando reporte..."),t()())}var Q=class l{fb=F(q);reportesSrv=F(J);loading=!1;errorMsg="";errorFecha="";datos=null;mostrarSoloConCompras=!0;vistaComprasPorDia="con-compras";form=this.fb.group({periodo:["mensual"],fecha_inicio:[null],fecha_fin:[null]});periodos=[{value:"hoy",label:"Hoy"},{value:"semanal",label:"\xDAltimos 7 d\xEDas"},{value:"mensual",label:"Mes actual"},{value:"anual",label:"A\xF1o actual"},{value:"personalizado",label:"Rango personalizado"}];ngOnInit(){this.cargarReporte()}formatearFecha(r){try{let e=new Date(r),n=String(e.getDate()).padStart(2,"0"),s=String(e.getMonth()+1).padStart(2,"0"),c=e.getFullYear();return`${n}/${s}/${c}`}catch{return r}}onPeriodoChange(){this.form.get("periodo")?.value==="personalizado"?(this.form.get("fecha_inicio")?.setValidators([D.required]),this.form.get("fecha_fin")?.setValidators([D.required,this.validarFechaFin.bind(this)])):(this.form.get("fecha_inicio")?.clearValidators(),this.form.get("fecha_fin")?.clearValidators(),this.form.get("fecha_inicio")?.setValue(null),this.form.get("fecha_fin")?.setValue(null),this.errorFecha=""),this.form.get("fecha_inicio")?.updateValueAndValidity(),this.form.get("fecha_fin")?.updateValueAndValidity()}validarFechaFin(r){let e=r.value,n=this.form.get("fecha_inicio")?.value;if(!e||!n)return null;let s=new Date(e),c=new Date(n);return s<c?{fechaAnterior:!0}:null}onFechaChange(){let r=this.form.get("fecha_inicio")?.value,e=this.form.get("fecha_fin")?.value;if(r&&e){let n=new Date(r);new Date(e)<n?(this.errorFecha="La fecha fin no puede ser anterior a la fecha inicio",this.form.get("fecha_fin")?.setErrors({fechaAnterior:!0})):(this.errorFecha="",this.form.get("fecha_fin")?.setErrors(null),this.form.get("fecha_fin")?.updateValueAndValidity())}else this.errorFecha=""}cargarReporte(){if(this.form.get("periodo")?.value==="personalizado"){let n=this.form.get("fecha_inicio")?.value,s=this.form.get("fecha_fin")?.value;if(!n||!s){this.errorFecha="Debe seleccionar ambas fechas";return}let c=new Date(n);if(new Date(s)<c){this.errorFecha="La fecha fin no puede ser anterior a la fecha inicio";return}}this.errorFecha="",this.loading=!0,this.errorMsg="",this.datos=null;let r=this.form.value,e={};r.periodo&&r.periodo!=="personalizado"?e.periodo=r.periodo:r.fecha_inicio&&r.fecha_fin&&(e.fecha_inicio=r.fecha_inicio,e.fecha_fin=r.fecha_fin),this.reportesSrv.reporteCompras(e).subscribe({next:n=>{this.datos=n,this.loading=!1},error:n=>{console.error("Error al cargar reporte:",n),this.errorMsg=n.error?.message||"Error al cargar el reporte de compras",this.loading=!1}})}get comprasPorDiaFiltradas(){return this.datos?this.vistaComprasPorDia==="con-compras"?this.datos.por_dia.filter(r=>r.cantidad>0||r.total>0):this.datos.por_dia:[]}exportarAExcel(){if(!this.datos){this.errorMsg="No hay datos para exportar";return}let r=_.book_new(),e=[["REPORTE DE COMPRAS"],[""],["Per\xEDodo:",this.datos.periodo.tipo],["Fecha Inicio:",this.formatearFecha(this.datos.periodo.fecha_inicio)],["Fecha Fin:",this.formatearFecha(this.datos.periodo.fecha_fin)],["D\xEDas:",this.datos.periodo.dias],[""],["RESUMEN GENERAL"],["Total Compras:",this.datos.resumen.total_compras],["Cantidad de Compras:",this.datos.resumen.cantidad_compras],["Compra Promedio:",this.datos.resumen.compra_promedio]],n=_.aoa_to_sheet(e);_.book_append_sheet(r,n,"Resumen");let s=[["Fecha","Cantidad","Total"],...this.comprasPorDiaFiltradas.map(u=>[this.formatearFecha(u.fecha),u.cantidad,u.total])],c=_.aoa_to_sheet(s);_.book_append_sheet(r,c,"Compras por D\xEDa");let p=[["Producto","Unidades","Total"],...this.datos.productos_mas_comprados.map(u=>[u.nombre,u.unidades,u.total])],Z=_.aoa_to_sheet(p);_.book_append_sheet(r,Z,"Productos M\xE1s Comprados");let ee=[["Usuario","Cantidad Compras","Total Comprado"],...this.datos.usuarios.map(u=>[u.nombre,u.compras,u.total])],te=_.aoa_to_sheet(ee);_.book_append_sheet(r,te,"Compras por Usuario");let ie=this.datos.periodo.fecha_inicio.replace(/-/g,""),oe=this.datos.periodo.fecha_fin.replace(/-/g,""),re=`Reporte_Compras_${ie}_${oe}.xlsx`;K(r,re)}static \u0275fac=function(e){return new(e||l)};static \u0275cmp=I({type:l,selectors:[["app-reporte-compras"]],decls:13,vars:7,consts:[[1,"space-y-6"],[1,"text-2xl","font-bold","text-center"],["class","mx-auto w-full max-w-6xl rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-red-300 text-center",4,"ngIf"],[1,"mx-auto","w-full","max-w-6xl","rounded-2xl","bg-surface-800","border","border-white/5","p-6"],[1,"text-lg","font-semibold","text-brand-500","mb-4"],[1,"space-y-4",3,"ngSubmit","formGroup"],["class","flex flex-col items-center gap-4",4,"ngIf"],["class","grid gap-4 md:grid-cols-2 lg:grid-cols-4",4,"ngIf"],["class","space-y-6",4,"ngIf"],["class","text-center py-12",4,"ngIf"],[1,"mx-auto","w-full","max-w-6xl","rounded-xl","border","border-red-500/40","bg-red-500/10","px-4","py-3","text-red-300","text-center"],[1,"flex","flex-col","items-center","gap-4"],[1,"w-full","max-w-md"],[1,"block","text-sm","mb-2"],["formControlName","periodo",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-2","outline-none","focus:border-brand-500",3,"change"],[3,"value",4,"ngFor","ngForOf"],[1,"w-full","max-w-md","flex","gap-2"],["type","submit",1,"flex-1","rounded-xl","bg-brand-500","text-black","font-semibold","px-4","py-2","hover:bg-brand-600","transition","disabled:opacity-50","disabled:cursor-not-allowed",3,"disabled"],["type","button",1,"flex-1","rounded-xl","bg-brand-500","text-black","font-semibold","px-4","py-2","hover:bg-brand-600","transition","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],[3,"value"],[1,"grid","gap-4","md:grid-cols-2","lg:grid-cols-4"],["type","date","formControlName","fecha_inicio",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-2","outline-none","focus:border-brand-500",3,"change"],["type","date","formControlName","fecha_fin",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-2","outline-none","focus:border-brand-500",3,"change","min"],[1,"flex","items-end","gap-2"],[1,"rounded-xl","bg-surface-900","border","border-white/5","p-4"],[1,"text-sm","text-textc-mute"],[1,"text-2xl","font-bold","text-brand-500"],[1,"text-2xl","font-bold"],[1,"text-lg","font-semibold"],[1,"flex","items-center","justify-between","mb-4"],[1,"text-lg","font-semibold","text-brand-500"],[1,"flex","items-center","gap-2"],[1,"rounded-lg","bg-surface-900","border","border-white/10","px-3","py-1","text-sm","outline-none","focus:border-brand-500",3,"ngModelChange","ngModel"],["value","con-compras"],["value","todas"],["class","text-center py-8 text-textc-mute",4,"ngIf"],["class","overflow-x-auto",4,"ngIf"],[1,"overflow-x-auto"],[1,"w-full","table-fixed"],[1,"w-1/3"],[1,"border-b","border-white/10"],[1,"text-left","py-3","px-4","text-sm","font-semibold"],[1,"text-center","py-3","px-4","text-sm","font-semibold"],["class","border-b border-white/5 hover:bg-surface-900/50",4,"ngFor","ngForOf"],[1,"text-center","py-8","text-textc-mute"],[1,"border-b","border-white/5","hover:bg-surface-900/50"],[1,"py-3","px-4"],[1,"py-3","px-4","text-center"],[1,"py-3","px-4","text-center","font-semibold"],[1,"text-center","py-12"],[1,"text-textc-mute"]],template:function(e,n){if(e&1&&(i(0,"div",0)(1,"h2",1),o(2,"Reporte de Compras"),t(),h(3,ae,2,1,"div",2)(4,ne,2,1,"div",2),i(5,"section",3)(6,"h3",4),o(7,"Filtros"),t(),i(8,"form",5),v("ngSubmit",function(){return n.cargarReporte()}),h(9,se,11,4,"div",6)(10,ce,19,9,"div",7),t()(),h(11,_e,79,20,"div",8)(12,xe,3,0,"div",9),t()),e&2){let s,c;a(3),d("ngIf",n.errorMsg),a(),d("ngIf",n.errorFecha),a(4),d("formGroup",n.form),a(),d("ngIf",((s=n.form.get("periodo"))==null?null:s.value)!=="personalizado"),a(),d("ngIf",((c=n.form.get("periodo"))==null?null:c.value)==="personalizado"),a(),d("ngIf",n.datos&&!n.loading),a(),d("ngIf",n.loading)}},dependencies:[N,M,X,Y,$,W,j,A,U,k,L,z,B,H,G,O],encapsulation:2})};export{Q as ReporteCompras};
