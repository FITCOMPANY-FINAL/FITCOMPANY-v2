import{b as V,c as h,d as F,e as P,g as $,h as X,k as L,p as B,r as z}from"./chunk-R2MBKBQG.js";import{a as O}from"./chunk-Y5NMKK7J.js";import{Ca as y,Ga as m,Mb as A,Nb as N,Pa as w,R as v,Sa as d,Sb as T,Ta as r,Ua as n,Va as g,Wa as C,X as f,Xa as M,Y as _,Ya as b,Yb as D,Za as u,_a as c,bb as S,db as R,eb as l,fb as E,gb as x,ta as s,wb as k}from"./chunk-4VXNIXON.js";function q(i,e){if(i&1&&(r(0,"div",24),l(1),n()),i&2){let o=c();s(),x(" ",o.okMsg," ")}}function G(i,e){if(i&1&&(r(0,"div",25),l(1),n()),i&2){let o=c();s(),x(" ",o.errorMsg," ")}}function H(i,e){if(i&1&&(r(0,"div",26),l(1),n()),i&2){let o=c();s(),x(" ",o.errorMsgInline," ")}}function U(i,e){if(i&1&&(r(0,"span",27),l(1),n()),i&2){let o=c();s(),x(" M\xE1ximo ",o.NOMBRE_MAX," caracteres. ")}}function Z(i,e){if(i&1&&(r(0,"span",27),l(1),n()),i&2){let o=c();s(),x(" M\xE1ximo ",o.DESC_MAX," caracteres. ")}}function J(i,e){if(i&1){let o=b();r(0,"button",28),u("click",function(){f(o);let a=c();return _(a.cancelarEdicion())}),l(1," Cancelar "),n()}}function K(i,e){i&1&&(r(0,"div",29),l(1,"Cargando\u2026"),n())}function Q(i,e){i&1&&(r(0,"div",29),l(1,"No hay registros"),n())}function W(i,e){i&1&&(r(0,"span",40),l(1,"Activo"),n())}function Y(i,e){i&1&&(r(0,"span",41),l(1,"Inactivo"),n())}function ee(i,e){if(i&1){let o=b();C(0),r(1,"button",42),u("click",function(){f(o);let a=c().$implicit,p=c(2);return _(p.editar(a))}),l(2,"Editar"),n(),r(3,"button",43),u("click",function(){f(o);let a=c().$implicit,p=c(2);return _(p.confirmarEliminar(a.id_rol))}),l(4,"Eliminar"),n(),M()}}function te(i,e){i&1&&(r(0,"span",41),l(1,"Protegido"),n())}function ie(i,e){if(i&1&&(r(0,"tr",33)(1,"td",34),l(2),n(),r(3,"td",34),l(4),n(),r(5,"td",34),m(6,W,2,0,"span",36)(7,Y,2,0,"span",37),n(),r(8,"td",38),m(9,ee,5,0,"ng-container",39)(10,te,2,0,"ng-template",null,0,k),n()()),i&2){let o=e.$implicit,t=S(11),a=c(2);R("opacity-60",o.estado==="I"),s(2),E(o.nombre_rol),s(2),E(o.descripcion_rol||"\u2014"),s(2),d("ngIf",o.estado==="A"),s(),d("ngIf",o.estado==="I"),s(2),d("ngIf",!a.isProtected(o))("ngIfElse",t)}}function re(i,e){if(i&1&&(r(0,"div",30)(1,"table",31)(2,"thead",32)(3,"tr",33)(4,"th",34),l(5,"Nombre"),n(),r(6,"th",34),l(7,"Descripci\xF3n"),n(),r(8,"th",34),l(9,"Estado"),n(),r(10,"th",34),l(11,"Acciones"),n()()(),r(12,"tbody"),m(13,ie,12,8,"tr",35),n()()()),i&2){let o=c();s(13),d("ngForOf",o.rows)}}function ne(i,e){if(i&1){let o=b();r(0,"div",44),g(1,"div",45),r(2,"div",46)(3,"h3",47),l(4,"Confirmar eliminaci\xF3n"),n(),r(5,"p",48),l(6,"\xBFSeguro que deseas eliminar este rol?"),n(),r(7,"div",49)(8,"button",50),u("click",function(){f(o);let a=c();return _(a.closeConfirm())}),l(9,"Cancelar"),n(),r(10,"button",51),u("click",function(){f(o);let a=c();return _(a.doEliminarConfirmado())}),l(11,"Aceptar"),n()(),r(12,"button",52),u("click",function(){f(o);let a=c();return _(a.closeConfirm())}),l(13,"\u2715"),n()()()}}var j=class i{fb=v(B);http=v(D);API=O.apiBaseUrl;NOMBRE_MAX=50;DESC_MAX=200;PATRON=/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s\-.]+$/;loadingList=!1;saving=!1;okMsg="";errorMsg="";errorMsgInline="";rows=[];editando=!1;editId=null;confirmOpen=!1;pendingDeleteId=null;form=this.fb.nonNullable.group({nombre_rol:["",[h.required,h.maxLength(this.NOMBRE_MAX)]],descripcion_rol:["",[h.maxLength(this.DESC_MAX)]]});ngOnInit(){this.loadData()}autoHide(e=4e3){window.setTimeout(()=>{this.okMsg="",this.errorMsg="",this.errorMsgInline=""},e)}showOk(e){this.okMsg=e,this.errorMsg="",this.errorMsgInline="",this.autoHide()}showError(e){this.errorMsg=e,this.okMsg="",this.errorMsgInline="",this.autoHide()}showInline(e){this.errorMsgInline=e,this.errorMsg="",this.okMsg="",this.autoHide()}toCanonical(e){return(e??"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/\s+/g,"").trim()}isProtected(e){return this.toCanonical(e?.nombre_rol||"")==="administrador"}loadData(){this.loadingList=!0,this.http.get(`${this.API}/roles`).subscribe({next:e=>{this.rows=e||[],this.loadingList=!1},error:e=>{console.error("Error al cargar roles:",e),this.rows=[],this.loadingList=!1,this.showError("Error al cargar los roles.")}})}submit(){if(this.saving)return;let e=(this.form.value.nombre_rol||"").trim().replace(/\s+/g," "),o=(this.form.value.descripcion_rol||"").trim().replace(/\s+/g," ");if(!e){this.showInline("El nombre es obligatorio.");return}if(!this.PATRON.test(e)){this.showInline("El nombre solo puede contener letras, espacios, guiones y puntos.");return}if(e.length>this.NOMBRE_MAX){this.showInline(`El nombre admite m\xE1ximo ${this.NOMBRE_MAX} caracteres.`);return}if(o.length>this.DESC_MAX){this.showInline(`La descripci\xF3n admite m\xE1ximo ${this.DESC_MAX} caracteres.`);return}this.saving=!0,this.errorMsgInline="",this.errorMsg="";let t={nombre_rol:e,descripcion_rol:o||""};(this.editando&&this.editId!=null?this.http.put(`${this.API}/roles/${this.editId}`,t):this.http.post(`${this.API}/roles`,t)).subscribe({next:p=>{this.saving=!1,this.showOk(p?.message||(this.editando?"Rol actualizado.":"Rol creado.")),this.loadData(),this.resetForm(),window.scrollTo({top:0,behavior:"smooth"})},error:p=>{this.saving=!1;let I=p?.error?.message||"Error al guardar el rol.";p?.status===400||p?.status===409?this.showInline(I):this.showError(I)}})}editar(e){this.isProtected(e)||(this.editando=!0,this.editId=e.id_rol??null,this.form.patchValue({nombre_rol:e.nombre_rol??"",descripcion_rol:e.descripcion_rol??""}),window.scrollTo({top:0,behavior:"smooth"}))}cancelarEdicion(){this.resetForm()}confirmarEliminar(e){this.pendingDeleteId=e??null,this.confirmOpen=!0}closeConfirm(){this.confirmOpen=!1,this.pendingDeleteId=null}doEliminarConfirmado(){if(this.pendingDeleteId==null){this.closeConfirm();return}let e=this.pendingDeleteId;this.closeConfirm();let o=this.rows.find(t=>t.id_rol===e);o&&this.isProtected(o)||this.http.delete(`${this.API}/roles/${e}`).subscribe({next:t=>{this.showOk(t?.message||"Rol eliminado correctamente."),this.loadData()},error:t=>{if(t?.status===409){let a=Number(t.error.usuarios??0);a>0?this.showError(`No se puede eliminar el rol porque est\xE1 siendo usado por ${a} usuario(s).`):this.showError(t?.error?.message||"No se pudo eliminar el rol.")}else this.showError(t?.error?.message||"No se pudo eliminar el rol.");this.loadData()}})}resetForm(){this.editando=!1,this.editId=null,this.form.reset({nombre_rol:"",descripcion_rol:""})}static \u0275fac=function(o){return new(o||i)};static \u0275cmp=y({type:i,selectors:[["app-roles"]],decls:36,vars:16,consts:[["protegido",""],[1,"space-y-6"],[1,"text-center","text-xl","font-bold"],["class","mx-auto w-full max-w-2xl rounded-xl border border-green-500/40 bg-green-500/10 px-4 py-3 text-green-300 text-center",4,"ngIf"],["class","mx-auto w-full max-w-2xl rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-red-300 text-center whitespace-pre-line",4,"ngIf"],["class","mx-auto w-full max-w-2xl rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-red-300 text-center",4,"ngIf"],[1,"mx-auto","w-full","max-w-2xl","rounded-2xl","bg-surface-800","border","border-white/5","p-6","sm:p-7"],[1,"text-lg","font-semibold","text-brand-500","mb-4"],["novalidate","",1,"space-y-5",3,"ngSubmit","formGroup"],[1,"block","text-sm","mb-1"],[1,"text-brand-500"],["type","text","formControlName","nombre_rol","autocomplete","off","placeholder","Ej: Administrador",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500","placeholder:text-sm"],[1,"mt-1","text-xs"],["class","text-red-400",4,"ngIf"],["type","text","formControlName","descripcion_rol","placeholder","Ej: Encargado de seguridad",1,"w-full","rounded-xl","bg-surface-900","border","border-white/10","px-4","py-3","outline-none","focus:border-brand-500","placeholder:text-sm"],[1,"flex","items-center","gap-3"],["type","submit",1,"flex-1","rounded-xl","border-2","border-dashed","border-brand-500/70","text-brand-500","font-semibold","py-3","hover:bg-brand-500","hover:text-black","transition","focus-visible:outline-none","focus-visible:ring-2","focus-visible:ring-brand-500",3,"disabled"],["type","button","class","px-4 rounded-xl border border-white/10 hover:bg-white/5 transition",3,"click",4,"ngIf"],[1,"mx-auto","w-full","max-w-4xl"],[1,"rounded-2xl","bg-surface-800","border","border-white/5","overflow-hidden"],[1,"px-6","py-4","border-b","border-white/5","font-semibold"],["class","px-6 py-10 text-center text-textc-mute",4,"ngIf"],["class","overflow-x-auto",4,"ngIf"],["class","fixed inset-0 z-[60] flex items-center justify-center",4,"ngIf"],[1,"mx-auto","w-full","max-w-2xl","rounded-xl","border","border-green-500/40","bg-green-500/10","px-4","py-3","text-green-300","text-center"],[1,"mx-auto","w-full","max-w-2xl","rounded-xl","border","border-red-500/40","bg-red-500/10","px-4","py-3","text-red-300","text-center","whitespace-pre-line"],[1,"mx-auto","w-full","max-w-2xl","rounded-xl","border","border-red-500/40","bg-red-500/10","px-4","py-3","text-red-300","text-center"],[1,"text-red-400"],["type","button",1,"px-4","rounded-xl","border","border-white/10","hover:bg-white/5","transition",3,"click"],[1,"px-6","py-10","text-center","text-textc-mute"],[1,"overflow-x-auto"],[1,"w-full","text-left","text-sm"],[1,"bg-surface-900/60"],[1,"border-b","border-white/5"],[1,"px-6","py-3"],["class","border-b border-white/5",3,"opacity-60",4,"ngFor","ngForOf"],["class","text-green-300",4,"ngIf"],["class","text-gray-400",4,"ngIf"],[1,"px-6","py-3","whitespace-nowrap"],[4,"ngIf","ngIfElse"],[1,"text-green-300"],[1,"text-gray-400"],["type","button",1,"text-brand-500","hover:text-brand-600","mr-3",3,"click"],["type","button",1,"text-red-400","hover:text-red-300",3,"click"],[1,"fixed","inset-0","z-[60]","flex","items-center","justify-center"],[1,"absolute","inset-0","bg-black/60"],[1,"relative","z-[61]","w-full","max-w-md","rounded-2xl","bg-surface-800","border","border-white/10","p-6","shadow-xl"],[1,"text-lg","font-semibold","mb-2"],[1,"text-sm","text-textc-mute"],[1,"mt-6","flex","gap-3","justify-end"],["type","button",1,"rounded-xl","border","border-white/10","px-4","py-2","hover:bg-white/5",3,"click"],["type","button",1,"rounded-xl","bg-brand-500","text-black","font-semibold","px-4","py-2","hover:bg-brand-600",3,"click"],["type","button","aria-label","Cerrar",1,"absolute","right-3","top-3","text-textc-mute","hover:text-white",3,"click"]],template:function(o,t){o&1&&(r(0,"div",1)(1,"h2",2),l(2,"Gesti\xF3n de Roles"),n(),m(3,q,2,1,"div",3)(4,G,2,1,"div",4)(5,H,2,1,"div",5),r(6,"section",6)(7,"h3",7),l(8),n(),r(9,"form",8),u("ngSubmit",function(){return t.submit()}),r(10,"div")(11,"label",9),l(12,"Nombre del rol "),r(13,"span",10),l(14,"*"),n()(),g(15,"input",11),r(16,"div",12),m(17,U,2,1,"span",13),n()(),r(18,"div")(19,"label",9),l(20,"Descripci\xF3n (opcional)"),n(),g(21,"input",14),r(22,"div",12),m(23,Z,2,1,"span",13),n()(),r(24,"div",15)(25,"button",16),l(26),n(),m(27,J,2,0,"button",17),n()()(),r(28,"section",18)(29,"div",19)(30,"div",20),l(31,"Lista de roles"),n(),m(32,K,2,0,"div",21)(33,Q,2,0,"div",21)(34,re,14,1,"div",22),n()(),m(35,ne,14,0,"div",23),n()),o&2&&(s(3),d("ngIf",t.okMsg),s(),d("ngIf",t.errorMsg),s(),d("ngIf",t.errorMsgInline),s(3),x(" ",t.editando?"Editar rol":"Agregar rol"," "),s(),d("formGroup",t.form),s(6),w("maxlength",t.NOMBRE_MAX),s(2),d("ngIf",((t.form.controls.nombre_rol.value==null?null:t.form.controls.nombre_rol.value.length)??0)>=t.NOMBRE_MAX),s(4),w("maxlength",t.DESC_MAX),s(2),d("ngIf",((t.form.controls.descripcion_rol.value==null?null:t.form.controls.descripcion_rol.value.length)??0)>=t.DESC_MAX),s(2),d("disabled",t.saving),s(),x(" ",t.saving?"Guardando\u2026":t.editando?"Actualizar":"Agregar"," "),s(),d("ngIf",t.editando),s(5),d("ngIf",t.loadingList),s(),d("ngIf",!t.loadingList&&t.rows.length===0),s(),d("ngIf",!t.loadingList&&t.rows.length>0),s(),d("ngIf",t.confirmOpen))},dependencies:[T,A,N,z,$,V,F,P,X,L],styles:["[_nghost-%COMP%]{display:block}"]})};export{j as Roles};
